# Multi-Stage Implementation Plan: Ghidra + Binary Ninja Reverse Engineering Pipeline

**Document Type:** Implementation Plan (PLN)
**Version:** 1.0
**Date:** 2025.11.19
**Project:** F1GP Disassembly & Native Port Initiative
**Status:** Draft

---

## Table of Contents
1. [Executive Summary](#executive-summary)
2. [Objectives & Scope](#objectives--scope)
3. [Planning Assumptions](#planning-assumptions)
4. [Approach Overview](#approach-overview)
5. [Stage Summary](#stage-summary)
6. [Detailed Stage Breakdown](#detailed-stage-breakdown)
7. [Cross-Cutting Workstreams](#cross-cutting-workstreams)
8. [Dependencies & Resource Plan](#dependencies--resource-plan)
9. [Risks & Mitigations](#risks--mitigations)
10. [Milestones & Acceptance Criteria](#milestones--acceptance-criteria)
11. [Next Actions](#next-actions)

---

## Executive Summary
This plan operationalizes the 2025.11.19 HLD by sequencing all work needed to stand up a dual-tool reverse engineering pipeline. The plan drives from repository bootstrap through automation and subsystem lifting so that Ghidra remains the authoritative disassembly source, Binary Ninja emits HLIL suitable for Rust integrations, and CI enforces determinism. Work is organized into six staged phases with clearly defined exit criteria, resource needs, and gating milestones culminating in a reusable toolchain for future F1GP port work.

## Objectives & Scope
- Deliver the repository structure (`re/` tree), tool scripts, and automation required to keep Ghidra/Binary Ninja artifacts in sync.
- Achieve ≥90% symbol coverage in Ghidra and HLIL exports for the five target subsystems (physics, AI, rendering, audio, input).
- Provide reproducible headless workflows (Linux CI) plus developer SOPs for onboarding.
- Integrate lifted outputs with `f1gp-port` telemetry harnesses for validation.

In-scope components mirror the HLD: `GP.EXE` disassembly, artifact schemas, Binary Ninja loader/exporters, automation scripts, CI jobs, and documentation. Out-of-scope remains any full static recompilation or emulator packaging.

## Planning Assumptions
- Tooling versions: Ghidra ≥11.0, Binary Ninja ≥4.0, Python 3.12, clang-format 17, DOSBox-X 2025.02.
- Licenses for Binary Ninja headless are procured and storable as CI secrets.
- Developers can allocate ~2 FTEs (1 RE specialist, 1 tooling/automation engineer) with ad-hoc support from the Rust gameplay team.
- Git LFS available for `.gpr` assets; CI runners have ≥4 cores and 16 GB RAM.

## Approach Overview
Work proceeds iteratively but gated by stage exit criteria. Early stages focus on repo scaffolding and deterministic scripts; mid stages bring the Binary Ninja lifting stack online; late stages emphasize automation, telemetry parity, and documentation. Cross-cutting workstreams (telemetry capture, schema evolution, knowledge sharing) run parallel but deliverables tie back into stage acceptance tests.

## Stage Summary
| Stage | Name | Duration* | Owner | Key Deliverables | Exit Criteria |
|-------|------|-----------|-------|------------------|---------------|
| S0 | Repo & Tooling Bootstrap | 3 days | Tooling Eng | `re/` skeleton, CONTRIBUTING, SHA tracking | Structure reviewed + committed |
| S1 | Ghidra Foundation | 1.5 weeks | RE Lead | Project template, exporter scripts, annotation SOP | `symbols.json`/`segments.yml` generated manually |
| S2 | Binary Ninja Foundation | 1 week | RE Lead + Tooling Eng | Loader/import scripts, HLIL export MVP | BN headless loads sample segments, emits HLIL for `Main_Loop` |
| S3 | Artifact Automation & Validation | 1 week | Tooling Eng | `refresh_artifacts.py`, schema validators, formatting hooks | Script regenerates artifacts end-to-end locally |
| S4 | CI & Telemetry Integration | 1.5 weeks | Tooling Eng + QA | CI jobs (`re-ghidra`, `re-binja`, `parity-tests`), DOSBox capture harness | All pipelines green, telemetry diff job passes |
| S5 | Subsystem Lifting Sprints | 3 weeks | RE Lead + Gameplay Liaison | HLIL exports + documentation for Physics/Input/Graphics/Audio/AI | ≥90% segment coverage, HLIL diffs ingested by `f1gp-port` |
| S6 | Handoff & Enablement | 0.5 week | PM + RE Lead | SOP bundle, final report, backlog of enhancement items | Sign-off from gameplay/port team |

\*Durations assume sequential focus; some workstreams overlap.

## Detailed Stage Breakdown
### Stage 0 – Repo & Tooling Bootstrap (Days 1–3)
- Tasks:
  - Create `re/` directory tree (`ghidra/`, `binary_ninja/`, `artifacts/`, `scripts/`), seed README + roadmap.
  - Add `.gitattributes`/Git LFS rules for `.gpr` and large binaries.
  - Commit SHA256 manifest for `GP.EXE` and ingestion notes.
  - Draft `wrk_docs/SOP - RE Contribution Guidelines (outline)` referencing naming conventions.
- Deliverables: Directory skeleton, initial documentation, manifest, backlog tickets for following stages.
- Exit Criteria: Repo reviewed; pre-commit hook ensures large binary tracking; stakeholders approve structure.

### Stage 1 – Ghidra Foundation (Days 4–14)
- Tasks:
  - Build project template with loader settings (x86:LE:16 real mode, overlays) and analyzer configuration.
  - Implement custom Ghidra scripts (`ExportSymbolsToJson.java`, `ExportSegmentsToYaml.java`, `TagInterruptUsage.py`, `EmitTypeDecls.py`).
  - Define annotation SOP (naming, comments, subsystem tags) in `re/ghidra/CONTRIBUTING.md`.
  - Run initial analysis session; produce draft artifacts for top-level functions (main loop, init, BIOS handlers).
- Deliverables: Template `.gpr`, script sources, documentation, first `symbols.json` & `segments.yml` snapshot with binary hash.
- Exit Criteria: Script outputs validated manually; coverage report shows ≥30% functions named; reviewers sign off on SOP.

### Stage 2 – Binary Ninja Foundation (Days 15–22)
- Tasks:
  - Author loader plugin `tools/bnn/f1gp_loader.py` to consume `segments.yml`, set sections/segments, and map far pointers.
  - Create `import_symbols.py` + `emit_hlil.py` to ingest artifacts and export HLIL C for specified symbol sets.
  - Configure HLIL settings (MLIL SSA, stack recovery, comment propagation) and document usage.
  - Produce proof artifact: HLIL for `Main_Loop`, `Physics_Init`, `BIOS_Int10_SetMode13h`.
- Deliverables: Binary Ninja plugin suite, configuration docs, sample HLIL under `re/artifacts/hlil/`.
- Exit Criteria: Headless Binary Ninja (CLI) runs using artifacts generated in Stage 1 and emits deterministic HLIL compared to reviewer baseline.

### Stage 3 – Artifact Automation & Validation (Days 23–29)
- Tasks:
  - Implement `scripts/re/refresh_artifacts.py` orchestrating headless Ghidra + Binary Ninja runs, schema validation, clang-format, codespell, and log generation.
  - Define JSON Schema/YAML spec for `symbols.json` and `segments.yml`; add unit tests.
  - Integrate telemetry trace metadata fields (e.g., `source_recording_id`) into exporter scripts.
  - Document command usage and troubleshooting in `re/README.md`.
- Deliverables: Automation script, schema files, unit tests, updated artifacts showing new metadata.
- Exit Criteria: Single command regenerates artifacts from scratch; script fails fast on validation errors; log file produced with tool versions.

### Stage 4 – CI & Telemetry Integration (Days 30–40)
- Tasks:
  - Set up CI jobs: `re-ghidra` (headless export), `re-binja` (headless HLIL), `parity-tests` (Rust harness + HLIL FFI).
  - Secure Binary Ninja license handling (encrypted secret, install cache) and document policy.
  - Build DOSBox-X capture harness to generate deterministic telemetry stored under `f1gp-data/dos_traces/`.
  - Wire telemetry metadata into automation script, ensuring each lifted function references at least one trace.
- Deliverables: CI pipeline definitions, telemetry harness scripts, sample trace data, documentation for license/secret handling.
- Exit Criteria: All CI jobs pass on main; telemetry harness produces reproducible outputs used by parity tests; HLIL diffs cause CI failures when missing.

### Stage 5 – Subsystem Lifting Sprints (Days 41–61)
- Tasks (iterative sprints, ~3–4 days each):
  1. **Physics** – Name & lift integration, suspension, tire, aerodynamics routines; add tests comparing to DOS traces.
  2. **Input** – Capture keyboard/joystick BIOS handlers, calibration routines.
  3. **Graphics** – Map render pipeline (Mode 13h ops, VGA port writes, screen buffers).
  4. **Audio** – Cover mixer, AdLib/SB drivers, data tables.
  5. **AI** – Analyze opponent behavior, racing line adjustments.
- For each sprint: expand Ghidra annotations, regenerate artifacts, verify HLIL readability, and sync docs into `f1gp-port/docs/re/`.
- Deliverables: Updated `symbols.json`, `segments.yml`, HLIL C files per subsystem, parity test reports, subsystem summary docs.
- Exit Criteria: ≥90% of executable segments have named functions/data; HLIL exports for five subsystems accepted by gameplay team; parity harness baseline recorded.

### Stage 6 – Handoff & Enablement (Days 62–65)
- Tasks:
  - Compile SOP bundle (Ghidra workflow, Binary Ninja workflow, artifact refresh checklist).
  - Write final status report summarizing coverage metrics, outstanding issues, and recommended backlog.
  - Host knowledge transfer session (recorded) for gameplay/port engineers.
- Deliverables: SOP pack, final report in `wrk_docs`, recorded demo link (if allowed), backlog tickets for future improvements (e.g., `mkdocs` dashboard).
- Exit Criteria: Stakeholders sign off; documentation merged; backlog prioritized for post-plan enhancements.

## Cross-Cutting Workstreams
- **Schema Evolution**: Maintain backward-compatible versions of `symbols.json`/`segments.yml`; include migration scripts and doc updates each time schema changes.
- **Telemetry & Parity**: Continuous capture of DOSBox traces, ensuring new subsystems have at least one golden capture; integrate with parity harness as new HLIL exports appear.
- **Quality Gates**: Pre-commit hooks for formatting; review templates requiring artifact diffs; nightly job verifying licenses/tool versions.
- **Security & Compliance**: Enforce access controls on ISO/GP.EXE; track license usage; document privacy considerations in exporting telemetry.

## Dependencies & Resource Plan
| Dependency | Needed By | Mitigation |
|------------|-----------|------------|
| Binary Ninja headless license | Stage 2 onward | Coordinate with IT for license server or floating license file prior to Stage 2 start.
| GitHub Actions macOS/Windows runners (optional) | Stage 4 | Start approval process early; fallback to Linux-only if delayed.
| clang-format/jsonschema tooling | Stage 3 | Vendor via existing DevOps base images.
| DOSBox-X 2025.02 build | Stage 4 | Package binary with project-specific config to avoid per-dev install drift.

Resource allocation:
- RE Lead (1.0 FTE) – owns Ghidra/Binary Ninja work, subsystem lifts.
- Tooling Engineer (0.75 FTE) – automation, CI, schema validation.
- QA/Gameplay Liaison (0.25 FTE) – telemetry harness, parity testing, integration check-ins.

## Risks & Mitigations
Referencing HLD risk table with implementation-specific actions:
1. **Loader/segment mismatch** – Add unit tests comparing Ghidra-exported segments to Binary Ninja loader expectations; include regression samples.
2. **License outages** – Mirror BN license file in secure artifact store; add manual override to skip HLIL export with clear warning.
3. **Telemetry drift** – Version DOSBox configs; embed checksums of trace inputs in artifacts.
4. **Team onboarding delays** – Deliver Stage 0 documentation + Stage 1 SOP early; pair new contributors with RE lead for first annotations.
5. **Tool upgrades breaking automation** – Pin tool versions in `scripts/re/tool_versions.json`; monthly job to validate newer releases before adoption.

## Milestones & Acceptance Criteria
| Milestone | Target Date | Acceptance Criteria |
|-----------|-------------|---------------------|
| M1 – Toolchain Bootstrap | 2025-11-24 | Stage 0 complete; repo structure + manifest approved. |
| M2 – Symbol Coverage 50% | 2025-12-05 | Stage 1 done; exporter scripts validated; ≥30% coverage, trending to 50% as Stage 2 begins. |
| M3 – HLIL for Physics/Input | 2025-12-15 | Stage 2/3 complete; automation script green; HLIL exports for initial subsystem set. |
| M4 – Graphics/Audio Lifts | 2025-12-29 | Stage 5 mid-sprints; parity harness captures for graphics/audio succeed. |
| M5 – CI Automation | 2026-01-05 | Stage 4 done; all CI jobs stable; telemetry diffs enforced. |
| M6 – Handoff Package | 2026-01-10 | Stage 6 complete; SOP + final report delivered and accepted. |

## Next Actions
1. Open tickets for Stage 0 tasks (repo skeleton, manifest, documentation outline).
2. Assign RE Lead/Tooling Engineer roles and align availability with Stage schedule.
3. Schedule license provisioning meeting (Binary Ninja headless + DOSBox-X distribution).
4. Kick off Stage 0 immediately; prepare review for structure approval within three days.
