# Journal Review Tool (jrnrvw) - Specification

**Version:** 1.0
**Date:** 2025.11.12
**Language:** Rust
**Interface:** Command Line Interface (CLI)

## Overview

The Journal Review Tool (`jrnrvw`) is a command-line utility designed to find, parse, and analyze task journal files across a directory tree. It provides insights into work patterns by grouping activities by repository and task, with flexible time-range filtering options.

## Purpose

Developers and teams often maintain journal files to track daily work, decisions, and progress. This tool helps:
- Aggregate journal entries from multiple locations
- Analyze work patterns over time
- Generate reports grouped by repository and task
- Filter activities by date ranges for reviews and retrospectives

## Journal File Format

### File Naming Convention
Journal files follow the naming pattern:
```
yyyy.mm.dd - JRN - <description>.md
```

**Examples:**
- `2025.11.12 - JRN - implemented auth module.md`
- `2025.11.10 - JRN - code review and bug fixes.md`
- `2025.11.05 - JRN - weekly planning.md`

### File Location
- Journal files can be located anywhere in the directory tree below the current working directory
- The tool recursively searches all subdirectories
- Common locations: `wrk_jrn/`, `docs/journal/`, project-specific directories

### File Content Structure
Journal files are expected to be markdown format with optional structure:
- Repository references (detected via git repository boundaries or explicit tags)
- Task identifiers (via headings, tags, or references)
- Timestamps and activity descriptions

## Core Features

### 1. File Discovery
- **Recursive Search:** Traverse directory tree from current or specified directory
- **Pattern Matching:** Identify files matching `yyyy.mm.dd - JRN - *.md` pattern
- **Date Extraction:** Parse dates from filenames for filtering and sorting
- **Repository Detection:** Identify which git repository each journal file belongs to

### 2. Content Analysis
- **Parse Markdown:** Extract structured information from journal entries
- **Task Identification:** Detect and extract task references from:
  - Markdown headings (`## Task: Feature Implementation`)
  - Issue references (`#123`, `ISSUE-456`)
  - Task tags (`[TASK-789]`)
- **Repository Association:** Group entries by their containing repository
- **Activity Extraction:** Capture key activities, decisions, and notes

### 3. Grouping and Organization
Primary grouping hierarchy:
```
Repository → Task → Journal Entries (chronological)
```

**Repository Grouping:**
- Detect git repository boundaries via `.git` directory
- Use repository name from git config or directory name
- Support nested repositories (monorepo scenarios)

**Task Grouping:**
- Group entries mentioning the same task identifier
- Support multiple task formats (GitHub issues, JIRA tickets, custom IDs)
- Handle entries spanning multiple days
- Option to show ungrouped/general entries

### 4. Time Range Filtering

**Predefined Ranges:**
- `--last-week`: Last 7 calendar days
- `--last-month`: Last 30 calendar days
- `--last-n-days <N>`: Last N calendar days
- `--last-n-active-days <N>`: Last N days where journals exist (excludes gaps)
- `--this-week`: Current week (Monday-Sunday)
- `--this-month`: Current calendar month

**Custom Ranges:**
- `--from <date>`: Start date (yyyy-mm-dd format)
- `--to <date>`: End date (yyyy-mm-dd format)
- `--date <date>`: Specific single date

**Activity-Based Filtering:**
- `--active-days-in-repo <N>`: Last N days of actual activity in each repository
- Useful for excluding weekends, holidays, or inactive periods

## Command Line Interface

### Basic Usage
```bash
# Analyze all journals in current directory tree
jrnrvw

# Analyze journals from last 7 days
jrnrvw --last-week

# Analyze journals from last 7 active days (days with journal entries)
jrnrvw --last-n-active-days 7

# Custom date range
jrnrvw --from 2025-11-01 --to 2025-11-12

# Analyze specific directory
jrnrvw --path /path/to/projects
```

### Command Options

#### Search Options
```
-p, --path <PATH>          Root directory to search (default: current directory)
-r, --recursive            Enable recursive search (default: true)
--max-depth <DEPTH>        Maximum directory depth to search
--include-hidden           Include hidden directories in search
```

#### Filtering Options
```
--last-week                Last 7 calendar days
--last-month               Last 30 calendar days
--last-n-days <N>          Last N calendar days
--last-n-active-days <N>   Last N days with journal entries
--this-week                Current week (Monday-Sunday)
--this-month               Current calendar month
--from <DATE>              Start date (yyyy-mm-dd)
--to <DATE>                End date (yyyy-mm-dd)
--date <DATE>              Specific date (yyyy-mm-dd)
--repo <REPO>              Filter by repository name
--task <TASK>              Filter by task identifier
```

#### Grouping Options
```
--group-by <MODE>          Grouping mode: repo-task, repo, task, date (default: repo-task)
--no-ungrouped             Hide entries without task identifiers
--merge-tasks              Merge similar task identifiers
```

#### Output Options
```
-o, --output <FORMAT>      Output format: text, markdown, json, html (default: text)
-f, --file <FILE>          Write output to file instead of stdout
--summary                  Show summary statistics only
--verbose                  Include full journal content in output
--quiet                    Minimal output (summaries only)
--no-color                 Disable colored output
```

#### Display Options
```
--sort <FIELD>             Sort by: date, repo, task, activity (default: date)
--reverse                  Reverse sort order
--limit <N>                Limit number of entries displayed
--show-paths               Display file paths in output
```

### Output Examples

#### Default Output (Text, Grouped by Repo → Task)
```
Repository: experiment
├── Task: FEAT-123 - Authentication System
│   ├── 2025.11.10 - JRN - implemented jwt validation.md
│   │   • Implemented JWT token validation
│   │   • Added refresh token logic
│   │   • Updated tests
│   └── 2025.11.12 - JRN - auth module review.md
│       • Code review feedback incorporated
│       • Fixed token expiry edge case
├── Task: BUG-456 - Login Form Validation
│   └── 2025.11.11 - JRN - fixed form validation.md
│       • Fixed email validation regex
│       • Added unit tests
└── Ungrouped Entries
    └── 2025.11.09 - JRN - weekly planning.md
        • Sprint planning meeting
        • Updated roadmap

Repository: api-service
├── Task: ISSUE-789 - Database Migration
│   └── 2025.11.08 - JRN - schema updates.md
│       • Designed new schema
│       • Created migration scripts

Summary:
- Total Journals: 5
- Date Range: 2025.11.08 - 2025.11.12
- Repositories: 2
- Tasks: 3
- Active Days: 5
```

#### Summary Output
```
Journal Activity Summary (2025.11.08 - 2025.11.12)

Repositories: 2
  • experiment: 4 journals, 3 tasks
  • api-service: 1 journal, 1 task

Tasks: 4 tracked
  • FEAT-123: 2 entries (experiment)
  • BUG-456: 1 entry (experiment)
  • ISSUE-789: 1 entry (api-service)
  • Ungrouped: 1 entry

Activity Days: 5
Most Active Day: 2025.11.10 (2 journals)
```

#### JSON Output
```json
{
  "summary": {
    "date_range": {
      "from": "2025-11-08",
      "to": "2025-11-12"
    },
    "total_journals": 5,
    "total_repositories": 2,
    "total_tasks": 3,
    "active_days": 5
  },
  "repositories": [
    {
      "name": "experiment",
      "path": "/home/user/experiment",
      "journal_count": 4,
      "tasks": [
        {
          "id": "FEAT-123",
          "title": "Authentication System",
          "journals": [
            {
              "date": "2025-11-10",
              "file": "2025.11.10 - JRN - implemented jwt validation.md",
              "path": "/home/user/experiment/wrk_jrn/2025.11.10 - JRN - implemented jwt validation.md",
              "activities": [
                "Implemented JWT token validation",
                "Added refresh token logic",
                "Updated tests"
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

## Technical Architecture

### Core Components

#### 1. File Scanner Module
**Responsibilities:**
- Directory traversal with configurable depth
- Pattern matching for journal files
- Date extraction from filenames
- Repository boundary detection

**Key Functions:**
```rust
pub fn scan_directory(path: &Path, config: &ScanConfig) -> Result<Vec<JournalFile>>;
pub fn extract_date_from_filename(filename: &str) -> Option<NaiveDate>;
pub fn find_repository_root(path: &Path) -> Option<PathBuf>;
```

#### 2. Parser Module
**Responsibilities:**
- Markdown parsing
- Task identifier extraction
- Activity extraction
- Metadata extraction

**Key Functions:**
```rust
pub fn parse_journal(content: &str) -> Result<JournalEntry>;
pub fn extract_tasks(content: &str) -> Vec<TaskReference>;
pub fn extract_activities(content: &str) -> Vec<Activity>;
```

#### 3. Analyzer Module
**Responsibilities:**
- Grouping logic (repo, task, date)
- Time range filtering
- Statistical calculations
- Data aggregation

**Key Functions:**
```rust
pub fn group_by_repo_and_task(journals: Vec<JournalEntry>) -> RepositoryGroup;
pub fn filter_by_date_range(journals: Vec<JournalEntry>, range: DateRange) -> Vec<JournalEntry>;
pub fn calculate_statistics(journals: &[JournalEntry]) -> Statistics;
```

#### 4. Formatter Module
**Responsibilities:**
- Output formatting (text, markdown, JSON, HTML)
- Color handling
- Tree structure rendering

**Key Functions:**
```rust
pub fn format_as_text(data: &AnalysisResult, options: &FormatOptions) -> String;
pub fn format_as_json(data: &AnalysisResult) -> String;
pub fn format_as_markdown(data: &AnalysisResult) -> String;
```

#### 5. CLI Module
**Responsibilities:**
- Argument parsing
- Configuration management
- Error handling and user feedback

**Dependencies:**
- `clap` for CLI argument parsing
- `clap_complete` for shell completions

### Data Structures

```rust
// Core data structures
pub struct JournalFile {
    pub path: PathBuf,
    pub date: NaiveDate,
    pub description: String,
}

pub struct JournalEntry {
    pub file: JournalFile,
    pub repository: Option<Repository>,
    pub tasks: Vec<TaskReference>,
    pub activities: Vec<Activity>,
    pub content: String,
}

pub struct Repository {
    pub name: String,
    pub path: PathBuf,
    pub remote: Option<String>,
}

pub struct TaskReference {
    pub id: String,
    pub title: Option<String>,
    pub task_type: TaskType, // GitHub, Jira, Custom
}

pub enum TaskType {
    GitHub(u32),        // #123
    Jira(String),       // PROJ-456
    Custom(String),     // [TASK-789]
    Heading(String),    // ## Task: Description
}

pub struct Activity {
    pub description: String,
    pub task: Option<String>,
}

pub struct DateRange {
    pub from: NaiveDate,
    pub to: NaiveDate,
}

pub struct AnalysisResult {
    pub repositories: Vec<RepositoryAnalysis>,
    pub summary: Summary,
}

pub struct RepositoryAnalysis {
    pub repository: Repository,
    pub task_groups: Vec<TaskGroup>,
    pub ungrouped: Vec<JournalEntry>,
}

pub struct TaskGroup {
    pub task: TaskReference,
    pub journals: Vec<JournalEntry>,
}

pub struct Summary {
    pub date_range: DateRange,
    pub total_journals: usize,
    pub total_repositories: usize,
    pub total_tasks: usize,
    pub active_days: usize,
    pub most_active_day: Option<(NaiveDate, usize)>,
}
```

### Key Dependencies

```toml
[dependencies]
clap = { version = "4.5", features = ["derive", "cargo"] }
chrono = "0.4"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
anyhow = "1.0"
thiserror = "1.0"
walkdir = "2.5"
regex = "1.10"
pulldown-cmark = "0.12"  # Markdown parsing
colored = "2.1"
itertools = "0.13"
```

## Implementation Phases

### Phase 1: Core Functionality
- [ ] File scanner with pattern matching
- [ ] Date extraction from filenames
- [ ] Repository detection
- [ ] Basic CLI with essential options
- [ ] Text output format
- [ ] Simple grouping (repo → task)

### Phase 2: Enhanced Analysis
- [ ] Markdown parsing for task extraction
- [ ] Multiple task identifier formats
- [ ] Activity extraction
- [ ] Date range filtering (all modes)
- [ ] Summary statistics

### Phase 3: Output Formats
- [ ] JSON output
- [ ] Markdown report generation
- [ ] HTML output with styling
- [ ] Colored terminal output

### Phase 4: Advanced Features
- [ ] Task merging/deduplication
- [ ] Configurable task patterns (via config file)
- [ ] Search within journal content
- [ ] Export to external tools (CSV, etc.)
- [ ] Interactive mode (TUI)

### Phase 5: Polish & Optimization
- [ ] Performance optimization for large trees
- [ ] Comprehensive error handling
- [ ] Shell completions (bash, zsh, fish)
- [ ] Documentation and examples
- [ ] Integration tests
- [ ] CI/CD pipeline

## Error Handling

The tool should gracefully handle:
- Invalid date formats in filenames
- Corrupted or empty journal files
- Permission denied errors
- Missing git repositories
- Invalid date range specifications
- Malformed markdown

Use `anyhow` for flexible error handling and `thiserror` for custom error types.

## Testing Strategy

### Unit Tests
- Date extraction from filenames
- Task identifier parsing
- Date range calculations
- Grouping logic

### Integration Tests
- File scanning with sample directory structure
- End-to-end CLI execution
- Output format validation

### Test Data
Create sample journal files and directory structures in `tests/fixtures/`

## Configuration File (Future)

Optional `~/.jrnrvw/config.toml`:
```toml
[task_patterns]
github = "#(\\d+)"
jira = "[A-Z]+-\\d+"
custom = ["\\[TASK-\\d+\\]", "Task:\\s*(.+)"]

[defaults]
group_by = "repo-task"
output_format = "text"
show_ungrouped = true

[colors]
enabled = true
repo_name = "cyan"
task_id = "yellow"
date = "green"
```

## Performance Considerations

- Implement parallel directory scanning for large trees
- Use streaming for file processing to handle large journals
- Cache repository detection results
- Provide `--max-depth` to limit recursion
- Add progress indicators for long operations

## Success Criteria

The tool is successful if it:
1. ✅ Correctly finds all journal files matching the pattern
2. ✅ Accurately groups entries by repository and task
3. ✅ Provides intuitive date range filtering
4. ✅ Generates clear, readable output
5. ✅ Handles edge cases gracefully
6. ✅ Performs well on large directory trees (>1000 journals)
7. ✅ Provides helpful error messages

## Future Enhancements

- **Web Dashboard:** Browser-based visualization of journal data
- **IDE Integration:** VS Code extension for inline journal management
- **AI Analysis:** Use LLMs to summarize journal content and identify patterns
- **Team Collaboration:** Aggregate journals across team members
- **Time Tracking:** Extract time spent on tasks from journal entries
- **Git Integration:** Correlate journal entries with git commits
- **Calendar View:** Visual calendar showing activity patterns

## References

- Markdown Spec: [CommonMark](https://commonmark.org/)
- Date Format: ISO 8601 (yyyy-mm-dd)
- CLI Design: [Command Line Interface Guidelines](https://clig.dev/)

---

**Document Status:** Draft
**Next Steps:** Review and approve specification before implementation
