# Implementation Plan: Ghidra Annotation & Coverage Campaign

**Document Type:** Implementation Plan  
**Version:** 1.0  
**Date:** 2025.11.20  
**Author:** Codex  
**Project:** F1GP Disassembly & Native Port Initiative  
**Status:** Draft

---

## 1. Overview
This plan operationalizes the annotation HLD. Work is broken into five sequential stages covering environment readiness, physics sprint, input/graphics expansion, automation hardening, and AI/audio completion with parity sign-off. Each stage lists tasks, owners, duration estimates, dependencies, and exit criteria.

## 2. Stage Summary
| Stage | Focus | Duration* | Owner(s) | Key Deliverables |
|-------|-------|-----------|----------|------------------|
| S0 | Environment Finalization | 2 days | Tooling Eng | DOSBox-X installed, Ghidra project synced, refresh pipeline verified end-to-end |
| S1 | Physics Sprint | 1.5 weeks | RE Lead, Telemetry Eng | ≥50 physics functions annotated, `physics_boot` trace captured, coverage >10 % |
| S2 | Input + Graphics Sprint | 1.5 weeks | RE Lead + Gameplay Liaison | Input handlers + rendering pipeline annotated, HLIL exports published, coverage >40 % |
| S3 | Automation & Binary Ninja | 1 week | Tooling Eng | Binary Ninja headless job enabled, HLIL publish pipeline green, parity harness wired to real traces |
| S4 | Audio + AI Sprint & Handoff | 2 weeks | RE Lead, Gameplay Liaison | Coverage ≥90 %, docs updated, parity harness regression suite ready for mainline |

\*Durations assume partial overlap where noted.

## 3. Detailed Stages
### Stage 0 – Environment Finalization
**Tasks**
1. Install DOSBox-X 2025.02+, verify `dosbox-x -version`.
2. Configure `capture_telemetry.py` macro paths; test dry-run + real capture (placeholder trace replaced).
3. Run `refresh_artifacts.py` without skip flags to confirm telemetry index, coverage report, HLIL publish (currently expected to warn until HLIL available).
4. Update developer SOP with Ghidra/JDK requirements and environment variables (`GHIDRA_HEADLESS`).

**Exit Criteria**
- DOSBox-X capture produces `sample_boot/trace.bin` (non-placeholder) and metadata.
- Ghidra headless run completes without warnings (EmitTypeDecls skip acceptable until needed).
- Logs stored under `re/artifacts/logs/` and coverage summary generated.

### Stage 1 – Physics Sprint
**Tasks**
1. Capture `physics_boot` telemetry via macro that runs a short lap; store under `f1gp-data/dos_traces/physics_boot/`.
2. Annotate physics-related code (suspension, integration, tire model) in Ghidra; add `@subsystem:physics` and `@trace:physics_boot` tags.
3. Run `refresh_artifacts.py` (no skip flags) to export symbols/segments/coverage.
4. Enable Binary Ninja import only for physics subset (optional) to validate loader.
5. Publish HLIL to `f1gp-port/docs/re/physics.c`; share with gameplay team for review.

**Exit Criteria**
- ≥50 named functions with `@subsystem:physics`.
- Coverage summary shows ≥10 % functions attributed to physics.
- Telemetry index references `physics_boot`; parity harness doc updated with new run ID.

### Stage 2 – Input + Graphics Sprint
**Tasks**
1. Design macros for keyboard/mouse sequences (`input_boot`), capture telemetry.
2. Annotate BIOS input handlers, joystick routines, VGA init/render loops; tag accordingly.
3. Run full refresh pipeline; ensure HLIL exports for `input.c` and `graphics.c` exist.
4. Update `f1gp-port/docs/re/` mirror; review for readability.
5. Record coverage delta in journal and coverage summary.

**Exit Criteria**
- Coverage >40 % overall, with clear breakdown between physics/input/graphics.
- Telemetry traces `input_boot` and `graphics_frame` recorded + referenced.
- Binary Ninja HLIL exports generated for both subsystems.

### Stage 3 – Automation & Binary Ninja Hardening
**Tasks**
1. Acquire Binary Ninja headless license, set `BINJA_LICENSE`/`BINJA_DOWNLOAD_URL` secrets.
2. Enable `re-binja` CI job; ensure `refresh_artifacts.py` runs without `--skip-binja` locally.
3. Update `publish_hlil.py` to clean destination by default (optional) and confirm docs mirror matches HLIL exports.
4. Enhance parity harness to ingest real telemetry (starting with physics trace) and enforce thresholds.
5. Document troubleshooting steps for automation scripts in `re/docs/ci.md`.

**Exit Criteria**
- CI pipelines `re-ghidra`, `re-binja`, and `re-parity` green on latest branch.
- HLIL exports auto-published after each refresh.
- Parity harness compares real traces (metadata + sample values) without failure.

### Stage 4 – Audio + AI Sprint & Handoff
**Tasks**
1. Capture audio and AI telemetry traces (e.g., `audio_mix`, `ai_race` macros).
2. Annotate audio mixers, AdLib/SB code, AI driver routines; add telemetry tags.
3. Run refresh pipeline and review coverage summary; target ≥90 % named functions.
4. Finalize docs: update `coverage_summary.md` snapshot, `re/docs/subsystem_lifting_playbook.md`, parity harness doc, and SOP.
5. Conduct handoff review with gameplay/port team; ensure `f1gp-port/docs/re/` has all subsystems.

**Exit Criteria**
- Coverage summary ≥90 % functions named.
- Telemetry index lists all sprint traces; parity harness includes at least physics + input + AI comparisons.
- Documentation bundle ready for final sign-off.

## 4. Dependencies
- DOSBox-X installation (Stage 0).
- Binary Ninja headless license (Stage 3).
- Telemetry macro scripts and legal approval for storing traces.
- Developer availability for annotation sprints (RE lead + gameplay liaison).

## 5. Risks & Mitigations
| Risk | Mitigation |
|------|------------|
| Headless script compatibility issues | Add Ghidra version checks (already handled) and document tested versions. |
| Telemetry captures fail under CI load | Keep sample traces committed; only replace with sanitized real traces once stable. |
| CI secrets leak | Store in GitHub Actions secrets with least privilege; rotate quarterly. |
| Annotation churn conflicts | Encourage analysts to work on subsystem-specific branches; rely on coverage summary for review gates. |

## 6. Reporting & Metrics
- `coverage_summary.md` tracked per PR; reviewers expect delta summary.
- `wrk_journals/…` updated for each sprint milestone.
- CI artifact uploads (symbols/segments/HLIL/logs) kept for 14 days.

## 7. Next Steps
1. Complete Stage 0 by installing DOSBox-X and running a real telemetry capture.
2. Assign Stage 1 owners (RE lead, telemetry engineer) and schedule kickoff.
3. Prepare Binary Ninja license request in parallel so Stage 3 is unblocked.
