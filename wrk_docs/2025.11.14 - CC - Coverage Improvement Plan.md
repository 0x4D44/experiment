# Code Coverage Improvement Plan: eBay MCP Server
**Date:** 2025-11-14
**Current Coverage:** ~15-20%
**Target Coverage:** 98%
**Estimated Duration:** 4-6 weeks (working incrementally)

---

## Phase 1: Foundation & Critical Paths (Target: 40% coverage)
**Duration:** Week 1-2
**Priority:** P0 - Critical
**Test Count:** ~60 tests

### Objectives
- Fix existing failing test
- Establish test infrastructure
- Cover critical execution paths
- Enable basic integration testing

### Tasks

#### 1.1 Fix Existing Issues
- [ ] **Fix database test** (src/storage/database.rs:223)
  - Debug conversion error
  - Fix schema or test data
  - Ensure test passes consistently
  - **Tests:** 1 fixed test

#### 1.2 Test Infrastructure Setup
- [ ] **Add test utilities module**
  ```rust
  tests/
  ├── common/
  │   ├── mod.rs
  │   ├── fixtures.rs      // Test data builders
  │   ├── mocks.rs          // Mock implementations
  │   └── helpers.rs        // Test helper functions
  ```
  - [ ] Create test data builders for models
  - [ ] Create mock implementations for async traits
  - [ ] Add test configuration helpers
  - **Tests:** 5-10 infrastructure tests

#### 1.3 Error Module Tests
- [ ] **src/error.rs** - Complete coverage
  - [ ] Test all error variant creation
  - [ ] Test Display trait implementation
  - [ ] Test From trait conversions
  - [ ] Test error source chain
  - **Tests:** 10-12 tests

#### 1.4 Models Module Tests
- [ ] **src/models/listing.rs**
  - [ ] Test EbayListing creation and defaults
  - [ ] Test Price creation and formatting
  - [ ] Test BuyingFormat conversions
  - [ ] Test serialization/deserialization
  - **Tests:** 8-10 tests

- [ ] **src/models/search.rs**
  - [ ] Test SearchFilters builder pattern
  - [ ] Test SearchFilters validation
  - [ ] Test SortOrder eBay parameter conversion
  - [ ] Test SearchResults creation
  - [ ] Test ShippingOptions combinations
  - **Tests:** 12-15 tests

- [ ] **src/models/config.rs**
  - [ ] Test AppConfig defaults
  - [ ] Test BrowserConfig validation
  - [ ] Test CacheConfig validation
  - [ ] **Tests:** 8-10 tests

#### 1.5 Storage Cache Tests
- [ ] **src/storage/cache.rs**
  - [ ] Test cache key generation
  - [ ] Test cache hit scenario
  - [ ] Test cache miss scenario
  - [ ] Test cache expiration (TTL)
  - [ ] Test cache eviction (max entries)
  - [ ] Test cache clear operation
  - [ ] Test concurrent access
  - **Tests:** 10-12 tests

### Deliverables
- All existing tests passing
- Test infrastructure in place
- Error handling fully tested
- Models 80% covered
- Cache system 70% covered
- **Estimated coverage: 40%**

---

## Phase 2: Core Functionality (Target: 60% coverage)
**Duration:** Week 3-4
**Priority:** P0-P1
**Test Count:** ~80 tests

### Objectives
- Test all database operations
- Test server protocol handling
- Test tool handlers
- Add integration tests

### Tasks

#### 2.1 Database Tests
- [ ] **src/storage/database.rs**
  - [ ] Test database initialization
  - [ ] Test search phrase CRUD operations:
    - [ ] Create/save search phrase
    - [ ] List all phrases
    - [ ] Get phrase by ID
    - [ ] Update phrase
    - [ ] Delete phrase
  - [ ] Test search history operations:
    - [ ] Save search history entry
    - [ ] Get recent history
    - [ ] Get history by phrase
    - [ ] Clear old history
  - [ ] Test transaction handling
  - [ ] Test concurrent database access
  - [ ] Test error scenarios (invalid IDs, constraints)
  - **Tests:** 20-25 tests

#### 2.2 Server Protocol Tests
- [ ] **src/server/protocol.rs**
  - [ ] Test message serialization/deserialization
  - [ ] Test InitializeRequest parsing
  - [ ] Test InitializeResponse creation
  - [ ] Test CallToolRequest parsing
  - [ ] Test CallToolResponse creation
  - [ ] Test error response formatting
  - [ ] Test all protocol message types
  - **Tests:** 15-18 tests

#### 2.3 Tool Handler Tests
- [ ] **src/server/tools.rs**
  - [ ] Test list_tools returns all tools
  - [ ] Test search_ebay tool handler:
    - [ ] Valid search request
    - [ ] Missing required parameters
    - [ ] Invalid parameter types
  - [ ] Test search_by_phrase handler
  - [ ] Test save_phrase handler:
    - [ ] Valid save
    - [ ] Duplicate name handling
  - [ ] Test list_phrases handler
  - [ ] Test update_phrase handler:
    - [ ] Valid update
    - [ ] Non-existent phrase
  - [ ] Test delete_phrase handler
  - [ ] Test get_history handler
  - [ ] Test clear_cache handler
  - [ ] Test error propagation
  - **Tests:** 25-30 tests

#### 2.4 Resource Handler Tests
- [ ] **src/server/resources.rs**
  - [ ] Test list_resources returns all resources
  - [ ] Test read_resource for config
  - [ ] Test read_resource for stats
  - [ ] Test read_resource for health
  - [ ] Test invalid resource requests
  - **Tests:** 8-10 tests

#### 2.5 Integration Tests
- [ ] **Create integration test suite**
  ```rust
  tests/
  ├── integration/
  │   ├── server_lifecycle.rs
  │   ├── end_to_end_search.rs
  │   ├── phrase_management.rs
  │   └── cache_integration.rs
  ```
  - [ ] Test server initialization and shutdown
  - [ ] Test full search workflow (stub browser)
  - [ ] Test phrase save and search by phrase
  - [ ] Test cache integration with searches
  - **Tests:** 12-15 integration tests

### Deliverables
- Complete database test coverage
- Server protocol fully tested
- All tool handlers tested
- Integration test framework established
- **Estimated coverage: 60%**

---

## Phase 3: Edge Cases & Complex Logic (Target: 80% coverage)
**Duration:** Week 5
**Priority:** P1-P2
**Test Count:** ~60 tests

### Objectives
- Test all error paths
- Test concurrent operations
- Test edge cases and boundaries
- Test browser pool management

### Tasks

#### 3.1 Search Manager Tests
- [ ] **src/search/manager.rs**
  - [ ] Test search with cache hit
  - [ ] Test search with cache miss
  - [ ] Test search with database save
  - [ ] Test search by saved phrase:
    - [ ] Existing phrase
    - [ ] Non-existent phrase
  - [ ] Test search history tracking
  - [ ] Test error propagation from scraper
  - [ ] Test error propagation from browser
  - [ ] Test concurrent searches
  - **Tests:** 15-20 tests

#### 3.2 Browser Pool Advanced Tests
- [ ] **src/browser/pool.rs**
  - [ ] Test pool initialization
  - [ ] Test browser acquisition:
    - [ ] Available browser
    - [ ] Pool exhausted (wait)
    - [ ] Pool exhausted (timeout)
  - [ ] Test browser release
  - [ ] Test browser cleanup on drop
  - [ ] Test concurrent acquire/release
  - [ ] Test browser restart on failure
  - [ ] Test pool shutdown
  - [ ] Test health check integration
  - **Tests:** 15-18 tests

#### 3.3 Scraper Advanced Tests
- [ ] **src/scraper/ebay.rs**
  - [ ] Test search retry logic:
    - [ ] Success on first try
    - [ ] Success after retry
    - [ ] Failure after max retries
    - [ ] CAPTCHA detection (no retry)
    - [ ] Rate limit (exponential backoff)
  - [ ] Test search with all filter combinations
  - [ ] Test pagination handling
  - [ ] Test URL encoding edge cases
  - [ ] Test search timeout
  - **Tests:** 15-18 tests

#### 3.4 Config Manager Tests
- [ ] **src/config/mod.rs**
  - [ ] Test configuration hot-reload
  - [ ] Test configuration file watching
  - [ ] Test invalid configuration handling
  - [ ] Test partial configuration updates
  - [ ] Test concurrent config reads during reload
  - [ ] Test environment variable overrides
  - **Tests:** 10-12 tests

#### 3.5 Anti-Detection Advanced Tests
- [ ] **src/browser/anti_detection.rs**
  - [ ] Test random delay bounds
  - [ ] Test user agent rotation
  - [ ] Test viewport variation
  - [ ] Test stealth args completeness
  - [ ] Test anti-detection with concurrent browsers
  - **Tests:** 5-8 tests

### Deliverables
- All error paths tested
- Concurrent operation testing
- Edge cases covered
- Complex state management tested
- **Estimated coverage: 80%**

---

## Phase 4: Comprehensive Coverage (Target: 98% coverage)
**Duration:** Week 6
**Priority:** P2-P3
**Test Count:** ~50 tests

### Objectives
- Achieve 98% line coverage
- Add property-based tests
- Add stress/load tests
- Cover remaining gaps

### Tasks

#### 4.1 Server Tests
- [ ] **src/server/server.rs**
  - [ ] Test server initialization
  - [ ] Test request handling:
    - [ ] Valid JSON-RPC requests
    - [ ] Invalid JSON
    - [ ] Unknown methods
    - [ ] Missing parameters
  - [ ] Test concurrent request handling
  - [ ] Test server shutdown gracefully
  - [ ] Test error recovery
  - **Tests:** 12-15 tests

#### 4.2 Property-Based Tests
- [ ] **Add proptest dependency**
  - [ ] Test URL building with random inputs
  - [ ] Test price parsing with random formats
  - [ ] Test cache key generation properties
  - [ ] Test serialization round-trips
  - [ ] Test filter combinations
  - **Tests:** 10-12 property tests

#### 4.3 Missing Coverage Gaps
- [ ] **src/main.rs**
  - [ ] Test CLI argument parsing
  - [ ] Test graceful shutdown signal handling
  - **Tests:** 4-5 tests

- [ ] **src/utils/logging.rs**
  - [ ] Test logger initialization
  - [ ] Test log level configuration
  - [ ] Test log formatting
  - **Tests:** 3-5 tests

- [ ] **Module exports** (mod.rs files)
  - [ ] Test all public API exports
  - **Tests:** 5-8 tests

#### 4.4 End-to-End Tests
- [ ] **Complete E2E test suite**
  - [ ] Full search workflow with mocked browser
  - [ ] Phrase management workflow
  - [ ] Cache and database interaction
  - [ ] Error handling across boundaries
  - [ ] Server lifecycle
  - **Tests:** 8-10 E2E tests

#### 4.5 Coverage Analysis & Gap Filling
- [ ] Run tarpaulin coverage report
- [ ] Identify uncovered lines
- [ ] Write targeted tests for gaps
- [ ] Verify 98% coverage achieved
- **Tests:** 10-15 gap-filling tests

### Deliverables
- 98% line coverage achieved
- Property-based tests added
- All critical paths tested
- Coverage report generated
- **Estimated coverage: 98%**

---

## Testing Standards

### Test Naming Convention
```rust
#[test]
fn test_<function_name>_<scenario>_<expected_result>()

// Examples:
#[test]
fn test_parse_price_valid_usd_returns_price()

#[tokio::test]
async fn test_search_cache_hit_returns_cached_result()
```

### Test Organization
- Unit tests in same file as code (in `#[cfg(test)] mod tests`)
- Integration tests in `tests/` directory
- Test utilities in `tests/common/`
- Test fixtures in `tests/fixtures/`

### Required Test Patterns
1. **AAA Pattern** (Arrange, Act, Assert)
2. **Given-When-Then** for complex scenarios
3. **Mock external dependencies**
4. **Use builders for test data**
5. **Test one concept per test**

### Coverage Requirements
- **Minimum line coverage:** 98%
- **Minimum branch coverage:** 95%
- **All public functions:** 100%
- **Error paths:** 100%

---

## Tools and Infrastructure

### Required Dependencies
```toml
[dev-dependencies]
tokio-test = "0.4"
tempfile = "3.8"
mockall = "0.12"           # NEW: Mocking framework
proptest = "1.4"            # NEW: Property-based testing
insta = "1.34"              # NEW: Snapshot testing
serial_test = "3.0"         # NEW: Serial test execution
```

### Coverage Tools
- **cargo-tarpaulin** - Already installed
- **cargo-llvm-cov** - Alternative coverage tool
- **codecov.io** - Coverage reporting (optional)

### CI Integration
```yaml
# .github/workflows/coverage.yml
- name: Run tests with coverage
  run: cargo tarpaulin --out Xml --output-dir ./coverage

- name: Upload coverage
  uses: codecov/codecov-action@v3

- name: Coverage gate
  run: |
    COVERAGE=$(grep -oP 'line-rate="\K[^"]+' coverage/cobertura.xml | head -1)
    if (( $(echo "$COVERAGE < 0.98" | bc -l) )); then
      echo "Coverage $COVERAGE is below 98%"
      exit 1
    fi
```

---

## Success Metrics

### Coverage Metrics
- [ ] Line coverage >= 98%
- [ ] Branch coverage >= 95%
- [ ] All public APIs tested
- [ ] All error paths tested

### Quality Metrics
- [ ] All tests passing
- [ ] No flaky tests
- [ ] Test execution < 30 seconds (unit)
- [ ] Test execution < 5 minutes (integration)

### Documentation
- [ ] All test modules documented
- [ ] Complex test scenarios explained
- [ ] Test data builders documented
- [ ] Coverage report published

---

## Risk Mitigation

### Potential Blockers
1. **Async testing complexity**
   - Mitigation: Use tokio-test utilities
   - Mitigation: Create async test helpers

2. **Browser automation mocking**
   - Mitigation: Use trait-based abstractions
   - Mitigation: Create mock browser implementation

3. **Database testing isolation**
   - Mitigation: Use temporary databases (tempfile)
   - Mitigation: Run database tests serially

4. **Test execution time**
   - Mitigation: Parallelize where possible
   - Mitigation: Use mocks to avoid slow operations
   - Mitigation: Separate unit and integration tests

---

## Phase-by-Phase Milestones

### Phase 1 Complete When:
- [ ] All tests passing
- [ ] Foundation tests written
- [ ] Coverage >= 40%
- [ ] CI passing

### Phase 2 Complete When:
- [ ] Core functionality tested
- [ ] Integration tests passing
- [ ] Coverage >= 60%
- [ ] No regressions

### Phase 3 Complete When:
- [ ] Edge cases covered
- [ ] Error paths tested
- [ ] Coverage >= 80%
- [ ] Performance acceptable

### Phase 4 Complete When:
- [ ] Coverage >= 98%
- [ ] All tests passing
- [ ] Documentation complete
- [ ] CI/CD integrated

---

## Conclusion

This multi-stage plan provides a systematic approach to achieving 98% code coverage for the eBay MCP server. By following these phases, we will:

1. Establish solid test infrastructure
2. Cover critical execution paths first
3. Systematically fill coverage gaps
4. Ensure production-ready code quality

The plan prioritizes critical functionality and builds incrementally, allowing for continuous integration and deployment throughout the process.
