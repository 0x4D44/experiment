# DOS Capture Playbook

_Last updated: 2025-11-19_

This guide explains how to capture golden telemetry/logs from the original Geoff Crammond Formula 1 Grand Prix (DOS)
release so we can compare the modern Rust port against authentic runs. Follow these steps whenever you record new
baseline data for parity work.

## 1. Environment Prep

1. Install **DOSBox Staging 0.80+** (preferred) or **PCem v17** for more deterministic timing. Set the cycle count to a
   fixed value (e.g., `cycles=fixed 12000`) to match the original hardware profile.
2. Create a clean DOS installation directory, e.g., `~/dos/F1GP_DOS/`, and copy the legally obtained game files
   (`HARDDISK/`, executables) into it. Record the ISO hash (SHA-256) in a manifest.
3. Configure DOSBox `dosbox.conf`:
   ```ini
   [serial]
   serial1=raw file dos_capture.log 19200
   ```
   This routes the in-game serial telemetry stream to `dos_capture.log` for later parsing.
4. Keep `dosbox.conf`, ISO hash, and DOSBox version together in `captures/manifest.json` so parity runs are reproducible.

## 2. Capture Workflow

1. Launch DOSBox and mount the game directory:
   ```
   mount C ~/dos/F1GP_DOS
   C:
   F1GP.EXE
   ```
2. Choose the desired scenario:
   - Tracks: Phoenix (dry baseline), Monaco (tech baseline), Monza (high-speed), Montreal/Silverstone (wet).
   - Weather: set via in-game options to match the parity scenario.
   - Car setup: default unless testing specific aero/gear cases.
3. Start the session and drive the required laps (minimum: 3 warmup + 2 hot laps). Ensure the serial capture file grows.
4. After the run, exit the game to flush `dos_capture.log`. Copy the file plus `SCREEN*.BMP`/video captures (optional) into
   `captures/<track>/<YYYYMMDD_HHMMSS>/`.
5. Compute SHA-256 hashes for `dos_capture.log` and any supporting files. Append to `captures/manifest.json` alongside:
   - Track name
   - Weather
   - Car setup summary
   - Driver name
   - Notes (incidents, invalid laps)

## 3. Sanitized Fixture

We include a tiny, synthetic telemetry capture (`data/fixtures/telemetry/synthetic_monaco.bin`) generated by the Rust
runtime. This file is **not** from DOS but enables CI/toolling tests without shipping proprietary data. Use it to verify
`telemetry_cli` or parity harness plumbing before ingesting real captures.

## 4. Comparing DOS vs. Rust

1. Convert the DOS serial log to CSV using the workspace CLI:
   ```bash
   cargo run -p dos_capture_parser -- export-csv \
     --input captures/monaco/20251118/dos_capture.log \
     --output captures/monaco/20251118/dos.csv
   ```
2. Convert the Rust capture with:
   ```bash
   cargo run -p telemetry_cli -- export-csv \
     --input telemetry/monaco-practice-1732000000.bin \
     --output exports/monaco_rust.csv --car 0
   ```
3. Feed both CSVs into the parity notebook/tool to compare lap times, sector times, speed traces, and control inputs.
4. Record drift metrics in `captures/parity_report.md`. Flag any deviation beyond
   - ±1% average lap time
   - ±2 km/h peak speed difference
   - >2° steering mismatch at the same timestamp

## 5. Checklist Before Publishing Captures

- [ ] ISO hash + DOSBox version recorded
- [ ] Serial log, manifest, and optional video placed in `captures/<track>/<timestamp>/`
- [ ] Hashes verified and stored in manifest
- [ ] Rust telemetry for the same scenario captured and exported via `telemetry_cli`
- [ ] Parity report updated with key deltas

Store the complete capture bundle outside the public repo (e.g., in internal storage or artifact buckets). Only manifests
and sanitized samples should ever land in git.
