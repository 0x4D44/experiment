# Code Review – Full Repository (2025-11-20)

## Scope & Method
- Reviewed core crate (`src/`) covering data parsing, physics, AI, game loop, rendering hooks, audio, and telemetry. Examined binaries (`f1gp`, `test_parser`, `parity_harness`) and workspace tools (asset/telemetry CLIs, fixture scripts). CI/script paths (`scripts/run_ci.sh`, fixture generators) inspected. No tests executed (network/filesystem constraints); findings are static analysis only. Plan tracked in `wrk_docs/2025.11.20 - CR - Plan.md`.

## High Priority Findings
- Engine never spins up: `update_engine_rpm` derives RPM from `wheel_speeds`, but those arrays are never populated after initialization. RPM clamps to idle, `apply_engine_force` then yields near-zero torque, so player/AI cars cannot accelerate and audio RPM is wrong. See `src/physics/car.rs:143-187`; no writes found via `rg wheel_speeds`. **Fix:** derive wheel speeds from linear velocity each frame or compute RPM from drivetrain model; keep torque free of divide-by-idle.
- Surface grip is permanently ratcheted down: each frame `apply_surface_grip` multiplies the existing grip state by the surface/weather multiplier (`src/physics/car.rs:339-353`). Grass or rain instantly erodes baseline grip and never restores when returning to asphalt. **Fix:** base grip should reset per tick (e.g., start from tire temperature grip, then apply surface/weather multiplier without mutation).
- Quaternion integration is mathematically incorrect: orientation update uses `body.orientation + angular_quat * body.orientation` (`src/physics/engine.rs:317-322`), which is not a valid integration step and quickly drifts/renormalizes to nonsense for any sustained angular velocity. **Fix:** integrate with `Quat::from_scaled_axis(ω*dt) * orientation` (or a proper exponential map) without additive blend.
- Physics world unused for cars: `GameState::update` advances `physics_world` but never inserts player/AI bodies (`src/game/state.rs:737-742`). Forces applied to `CarPhysics` never enter the world; collision/constraint resolution is impossible. **Fix:** either remove the unused world or register bodies and drive all integration through it.

## Medium Priority
- Track parsing relies on heuristic skip-table search (`src/data/parser.rs:607-686`); when no candidate passes length heuristics it still returns an empty/short track quietly (e.g., Montreal is already skipped in `main.rs`). **Fix:** surface a hard error when no valid section set is found; tighten validation (min section count, consistent length, header checksum) and return context in `TrackAsset`.
- Collision & lap logic samples only the nearest section center (`src/physics/collision.rs:44-101`), ignoring segment vectors and direction. On tight bends or overlapping geometry this can misclassify surfaces and trigger false lap crossings. **Fix:** project position onto section vectors, use signed lateral distance, and include heading continuity for lap detection.
- Telemetry capture is unbounded: every frame pushes samples for all cars without rate limiting or size guard (`src/game/state.rs:1138-1188`). Long sessions can exhaust memory; failure to build an output path leaves all data in RAM until drop. **Fix:** decimate (e.g., 10 Hz), cap samples per recording, and immediately flush to disk when the path is valid.
- Orientation → camera yaw: `get_car_rotation` extracts yaw directly from quaternion (`src/game/state.rs:892-909`); given the broken orientation integration, HUD/renderer receives unstable angles. This will be resolved by fixing physics integration but should be revalidated with normalization and gimbal-safe extraction.

## Low Priority / Observations
- Tests: integration tests in `tests/track_loading.rs` silently skip when assets are absent; rendering/audio/gameflow paths lack coverage. Consider headless snapshot tests for HUD/camera math and golden CSVs for telemetry CLI.
- CI: `scripts/run_ci.sh` regenerates fixtures and sprite atlases on every run; ensure contributors know this mutates `data/fixtures/` and may bloat diffs. Add a guard to skip regeneration when outputs are unchanged.
- Tools: `telemetry_cli diff` pairs rows by index rather than timestamp, which can hide drift when sample rates differ; sort/align by time before diffing.

## Recommendations & Next Steps
1) Repair drivetrain loop: compute wheel speeds from chassis velocity each frame, refactor RPM→torque calculation, and add regression tests for acceleration curves.  
2) Rework grip application: derive grip from temperature + surface + weather without mutating baseline; add tests that grip recovers after returning to track.  
3) Fix quaternion integration and funnel all bodies through `PhysicsWorld`; add integration tests that conserve energy/damping over multiple steps.  
4) Harden track parser: reject empty/invalid parses, log precise offset candidates, and add fixture-based tests for known tracks (including Montreal).  
5) Add telemetry rate limiting and file-path guarding; verify `Drop` flush does not allocate unbounded memory during long races.  
6) Extend coverage: smoke tests for `GameState::update`, HUD output, telemetry CLI diff, and basic AI steering to prevent regressions.  
7) Update contributor docs to clarify fixture regeneration side-effects in CI.
