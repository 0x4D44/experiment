# 2025-11-19 – Implementation Plan: F1GP Parity

## Overview
This plan translates the parity-oriented HLD into actionable stages. Workstreams are grouped by phase, each with goals, key tasks, dependencies, acceptance criteria, and suggested sequencing. Owners/resources are left blank for assignment.

**Governance & checkpoints**
- Every phase begins with a kickoff reviewing scope/risks and ends with a stage-gate demo where success criteria are verified (tests + telemetry reports).
- Weekly syncs track progress, blockers, and cross-team dependencies (data, rendering, physics, QA, legal).
- Metrics to capture per phase: planned vs. actual velocity, test coverage deltas, telemetry drift, perf headroom.
- Exit from a phase requires an approved retro + updated roadmap before downstream work starts.

## Phase 1 – Data Foundation (Weeks 1–6)
**Goals:** Deterministic ingestion of original assets, validated schemas, tooling for legal extraction, baseline CI fixtures.

| Task | Description | Dependencies | Deliverables / Acceptance |
|------|-------------|--------------|---------------------------|
| 1.1 Track parser rewrite | Implement offset correction, checksum validation, decode sections/commands/racing lines/objects/horizon | None | `TrackAsset` struct populated for ≥5 tracks; parser unit tests covering failure cases |
| 1.2 Racing-line & metadata schema | Convert segments/commands to structured data (`RacingLineAsset`, `TrackMeta`) | Task 1.1 | JSON schema for telemetry, CLI to dump racing-line preview |
| 1.3 Asset extractor CLI | `tools/extract_assets.py` (or Rust equivalent) to copy/verify DAT files; checksum manifest | None | CLI docs, hashed manifest, automated verification step |
| 1.4 Driver/car DB ingest | Parse driver/team stats; build overlay format; sample dataset for CI | None | `DriverDB` with full 1991 roster; README instructions |
| 1.5 Audio/UI extractor | Scripts to pull PCM samples + bitmap fonts; hashed references | None | PCM conversion tool + sample atlas; fallback assets for CI |
| 1.6 Sanitized fixtures & CI setup | Create minimal open-source track/audio fixtures for automated tests | Tasks 1.1–1.5 | CI pipeline that runs parser tests without proprietary data |
| 1.7 Telemetry schema definition | Binary/JSON schema covering car state for parity harness | Task 1.2 | Spec document + serializer/deserializer unit tests |
| 1.8 DOS capture prep | Document DOSBox/PCem setup, seed scenarios, automate capture scripts | Task 1.7 | Reference capture playbook + sample sanitized logs |

**Exit Criteria:** Parser validates all sections of 5 reference tracks; driver DB complete; asset extraction documented; CI green using sanitized fixtures.

## Phase 2 – Rendering & UI (Weeks 7–14)
**Goals:** Faithful isometric renderer, HUD/UI screens, modern-mode hook, parity visuals.

| Task | Description | Dependencies | Deliverables / Acceptance |
|------|-------------|--------------|---------------------------|
| 2.1 Sprite pipeline | Build sprite atlas from extracted bitmaps; palette/dithering implementation | Phase 1.5 | Atlas generator, runtime sprite loader, palette tests |
| 2.2 Isometric renderer core | Implement tile renderer, depth sorting, horizon layers, TV camera positions | 2.1, 1.1 | Renderer draws Monaco track with horizon & kerbs within 1px diff vs. DOS capture |
| 2.3 HUD replication | Gear/speed/lap/time widgets, flag indicators, fonts | 2.1 | HUD screenshot diff <1 tile vs. DOS |
| 2.4 Menu/UI screens | Main menu, options, car setup, track select, race results; VGA transitions | 2.1 | UX flows playable with keyboard, matching layouts |
| 2.5 Mode toggles & modern path | Tie renderer to parity/modern switch; share render state with future 3D mode | 2.2 | Config toggle persisted; parity mode default |
| 2.6 Input options UX | Menu for control bindings, joystick calibration UI skeleton | Phase 4 dependency | UI scaffolding ready |
| 2.7 Visual regression tests | Golden image pipeline using sanitized fixtures | 2.2–2.4 | CI job comparing render outputs |

**Exit Criteria:** Practice lap renders identically (±1 px) on Monaco; HUD/UI parity verified; golden image tests active.

## Phase 3 – Physics & AI (Weeks 15–28)
**Goals:** Authentic handling, AI behaviors, full grid, telemetry parity.

| Task | Description | Dependencies | Deliverables / Acceptance |
|------|-------------|--------------|---------------------------|
| 3.1 Physics upgrade | Wheel-speed calc, tire models, kerb/banking, suspension | 1.1, 2.2 | Physics unit/integration tests; lap-time within ±2% |
| 3.2 Car setup integration | Apply per-track aero/ratios from data; setup UI integration | 3.1, 2.4 | Car setup affects lap times consistent with DOS |
| 3.3 Surface/weather model | Wet/dry grip tables, rain transitions, telemetry capture | 3.1 | Rainy vs. dry lap-time delta matches reference |
| 3.4 AI racing-line usage | Convert racing-line segments to splines, speed profiles | 1.2, 3.1 | AI follows parsed line, minimal overshoot |
| 3.5 AI personalities & grid expansion | Full 26-car lineup, driver stats, blue/yellow flags, pit logic | 3.4 | 26 cars complete race; flags triggered correctly |
| 3.6 Session Manager | Countdown, practice/qualy/race, safety car if applicable | 3.5 | End-to-end weekend simulated |
| 3.7 Telemetry parity harness | DOS capture pipeline + Rust comparison tool | 1.7 | Automated parity report, thresholds enforced |

**Exit Criteria:** Single-track Grand Prix weekend runs within telemetry thresholds; AI fields complete; parity harness produces acceptable delta report.

## Phase 4 – Audio & Controls (Weeks 29–36)
**Goals:** Authentic audio playback, menu music, joystick support, configuration persistence.

| Task | Description | Dependencies | Deliverables / Acceptance |
|------|-------------|--------------|---------------------------|
| 4.1 Audio mixer | PCM playback engine, channel priority, SB/AdLib emulation curves | 1.5, 3.1 | Spectral comparison within ±3 dB; runtime audio toggles |
| 4.2 Music/sequencer | Implement menu/background music playback (converted OPL/PCM) | 4.1 | Menu music loops match original tempo |
| 4.3 Audio config UI | Volume/mute/mix mode persistence | 4.1 | Options screen updates config file |
| 4.4 Joystick/gamepad support | SDL2 controller mapping, calibration, deadzone logic | 2.6 | Joystick lap completes without drift; config saved |
| 4.5 Input rebinding UI | Save/load control profiles, split-keyboard mode | 4.4 | Profiles persisted per user, accessible in menu |
| 4.6 Accessibility | Basic aids (auto-shift toggle, colorblind HUD palette) | 2.3, 4.5 | Options documented; toggles persisted |

**Exit Criteria:** Audio tests pass spectral diff, joystick fully supported, controls configurable, accessibility toggles available.

## Phase 5 – Sessions, Packaging & Polish (Weeks 37–48)
**Goals:** Complete Grand Prix feature set, installers, documentation, parity enforcement.

| Task | Description | Dependencies | Deliverables / Acceptance |
|------|-------------|--------------|---------------------------|
| 5.1 Pit stops & strategy | Pit entrance detection, fueling, tire wear, crew animation | 3.5 | Pit cycles match DOS timing ±0.5s |
| 5.2 Replay/saved games | Deterministic replay system leveraging telemetry | 3.7 | Replay of reference race matches initial run |
| 5.3 Packaging/installer | Build scripts, launcher, asset detection, EULA flow | All previous | Installers for Win/Linux/macOS with asset wizard |
| 5.4 Documentation refresh | README, user guides, asset extraction instructions | All previous | Docs reflect reality; versioned | 
| 5.5 Parity enforcement | CI gate using parity harness across baseline scenarios | 3.7 | Release blocked unless thresholds met |
| 5.6 Performance tuning | Profiling on target platforms + optimizations | All previous | Maintains ≥60 FPS parity mode on target HW |
| 5.7 Release readiness | Issue burn-down, QA checklist, tagging process | All previous | v1.0 parity release candidate |

**Exit Criteria:** Full weekend playable, installers ship with docs, parity harness green, release checklist satisfied.

## Cross-Cutting Workstreams
- **Project Management:** Maintain Kanban/roadmap, sprint planning, stakeholder updates each phase.
- **Quality Assurance:** Expand automated tests per phase, schedule manual regression passes, capture DOS reference data early.
- **Telemetry & Tooling:** Keep telemetry schema stable; coordinate DOS capture sessions for baseline tracks; update parity thresholds as tuning improves; ensure parity harness scripts stay in lockstep with asset versions.
- **Legal & Compliance:** Review extraction tools, README warnings, and EULA text with legal counsel before release.
- **DOS Capture Program:** Maintain a secure archive of reference recordings, document hardware/software requirements, and schedule refresh cycles when physics/AI tuning changes.

## Resource & Capability Matrix
| Phase | Core Skills Needed | Notes |
|-------|-------------------|-------|
| Phase 1 | Low-level Rust, binary reverse engineering, tooling/CLI expertise, build/CI | Coordinate with legal for extraction guidance |
| Phase 2 | Graphics/engine dev (2D pipelines), UI/UX, asset pipeline, automation for golden tests | Close collaboration with art/data owners |
| Phase 3 | Physics/AI engineering, numerical methods, gameplay programming, telemetry analytics | Requires dedicated QA for regression laps |
| Phase 4 | Audio DSP, SDL controller integration, accessibility design | Share resources with UX for UI updates |
| Phase 5 | Gameplay/UX polish, installer/DevOps, technical writing, release management | Engage legal + community team |

Assign leads ahead of each phase; ensure knowledge transfer (pairing, docs) occurs during overlaps.

## Milestones & Timeline Summary
1. **M1 (Week 6):** Data foundation complete; parser/tests/driver DB ready.
2. **M2 (Week 14):** Rendering/HUD/UI parity achieved.
3. **M3 (Week 28):** Physics/AI parity on reference track; telemetry harness operational.
4. **M4 (Week 36):** Audio and control enhancements complete; accessibility features ready.
5. **M5 (Week 48):** Full sessions, packaging, parity enforcement; release candidate built.

Adjust timeline based on staffing; each milestone requires design reviews and retrospectives.

## Risks & Mitigations
| Risk | Phase Impacted | Mitigation |
|------|----------------|------------|
| Asset legal hurdles delay extraction | 1–5 | Engage legal early, document required user actions, ship dummy fixtures to unblock CI |
| DOS capture instability / tooling drift | 1,3,5 | Automate capture scripts, version control configs, schedule validation runs monthly |
| Performance regressions in parity mode | 2–5 | Instrument frame-time telemetry, set perf budgets, run perf CI on target HW |
| Cross-platform issues (SDL/WGPU differences) | 2–5 | Maintain nightly builds on Win/Linux/macOS, include smoke UI tests |
| Scope creep from modern mode enhancements | 2–5 | Enforce parity-mode-first rule; optional features require design review |
| Resource contention (physics vs. rendering) | 2–3 | Stagger staffing, ensure shared utilities documented |
