# 2025-11-19 – Racing Line & Section Metadata Schema

## 1. Purpose
The `racing_line_cli` tool exports canonical JSON describing track sections, offsets, and racing-line segments parsed from
F1GP DAT files. This schema feeds Task 1.2 (Racing-line & metadata) by giving AI, parity, and tooling teams a stable data
contract.

## 2. JSON Structure
Each export file contains a single `TrackExport` object:

```json
{
  "name": "Monaco",
  "file": "assets/original/F1CT04.DAT",
  "checksum": { "stored": 123456789, "computed": 123456789, "valid": true },
  "offsets": {
    "base_offset": 0,
    "checksum_position": -239,
    "object_data": 1224,
    "track_data": 1024
  },
  "header": {
    "start_width": 18,
    "kerb_type": 2,
    "pole_side": 1,
    "pits_side": 0
  },
  "section_data_offset": 4370,
  "section_skip_hint": 1200,
  "section_count": 70,
  "sections": [ ... ],
  "racing_line": {
    "displacement": 0,
    "segments": [ ... ]
  }
}
```

### 2.1 Section Entries
Each `sections[]` entry mirrors the parser’s `TrackSection` fields and uses meter-based units:

| Field | Type | Notes |
|-------|------|-------|
| `index` | `usize` | Sequential order along the circuit. |
| `length` | `f32` | Meters for the normalized section length. |
| `curvature` | `i16` | Raw curvature value (positive = right). |
| `height` | `i16` | Raw elevation delta. |
| `flags` | `u16` | Original bitfield; consumers decode as needed. |
| `width` | `f32` | Track width at this section (meters). |
| `position` | `[f32;3]` | Derived world position (meters). |
| `surface` | `String` | Enum name (`Track`, `Grass`, etc.). |
| `commands` | `Vec<TrackSectionCommand>` | Raw commands for signage, objects, etc. |

### 2.2 Racing Line
`racing_line.segments` is a verbatim dump of `RacingLineSegment` (length, correction, segment type). Segment lengths are
bytes from the DAT file; consumers convert to meters using section metadata.

## 3. Usage Flow
1. Export metadata:
   ```bash
   cargo run -p racing_line_cli -- export \
     --inputs assets/original/F1CT04.DAT \
     --output exports/tracks --pretty
   ```
2. Feed JSON into AI tooling (e.g., convert to splines, plan braking points).
3. Store exports alongside telemetry captures for parity harness so both geometry and driver traces share a common revision.

## 4. Future Extensions
- Add derived fields: cumulative distance, curvature radius in meters, banking angles, pit lane segmentation.
- Publish schema version field once we add optional metadata to avoid consumer breakage.
- Integrate with parity harness (compare DOS vs. Rust racing line to ensure offsets match).
