# 2025-11-19 – Gap Analysis: F1GP Modern Port vs. Original DOS Target

## 1. Goal Context
The stated objective is to reproduce Geoff Crammond’s Formula 1 Grand Prix (1991 DOS) in Rust with matching graphics, audio, controls, AI, drivers, and reuse of the original files. The README currently declares a “v1.0 COMPLETE” release with full fidelity (graphics, sound, drivers, 15 tracks). In reality the runtime still implements a prototype 2D view, placeholder assets, procedural audio, partial driver roster, and heuristic parsers. The following sections map concrete code to the goal and highlight the gaps.

## 2. Current Implementation Snapshot
- **Entry point / loop** – `src/main.rs` sets up SDL2, a minimal menu, and loads DAT tracks from `assets/original`, but the experience is limited to a single player view, 1280×720 top-down rendering, and up to five AI spawns (`src/main.rs:22-110`, `src/game/state.rs:208-268`).
- **Rendering** – The 2D renderer projects track sections directly into screen-space using simple lines and circles, not the original isometric art (`src/render/track_renderer.rs:37-169`, `src/render/car_renderer.rs:60-83`). A WGPU 3D pipeline exists but is not wired into gameplay and still has TODOs (e.g., “render AI cars”) (`src/render3d/renderer.rs:620-767`).
- **Simulation** – Physics is a bespoke rigid-body loop with simplified grip and no integration with the original data tables. Wheel speeds are never updated after initialization, so RPM/gear logic is decoupled from vehicle motion (`src/physics/car.rs:74-179`). Track collision is a distance-to-center check using constant widths, ignoring actual verge and kerb data (`src/physics/collision.rs:52-101`).
- **AI** – Racing-line following and speed targets rely on placeholders: line points default to section centers and speeds are hard-coded to 50 m/s; when no track data is present, a synthetic circle is generated (`src/ai/racing_line.rs:21-48`). Only five driver personalities are implemented, and the car database contains three teams and six drivers (`src/game/state.rs:226-263`, `src/data/car.rs:212-288`).
- **Audio** – The new SDL2-based `SoundEngine` synthesizes engine, gear, and effect sounds procedurally (sawtooth/noise); no original samples or mixing of asset files occurs (`src/audio/sound_engine.rs:1-398`).
- **Assets & data** – The DAT parser still guesses offsets via brute-force skip tables, leaves object shapes, racing lines, pits, and cameras empty, and simply logs a warning when no sections can be read (`src/data/parser.rs:540-618`). Integration tests require the proprietary track files and silently skip when absent (`tests/track_loading.rs:6-55`).
- **Documentation** – The README advertises “v1.0 COMPLETE” with authentic isometric rendering and comprehensive systems that do not exist in code (`README.md:5-69`).

## 3. Detailed Gaps vs. Original DOS Experience

### 3.1 Asset Fidelity & Data Flow
1. **Incomplete track parsing** – Brute-force skips and the absence of checksum validation mean the parser cannot robustly locate sections across all 16 tracks. Even after parsing, racing-line segments, pit lane data, cameras, and object shapes are left empty (`src/data/parser.rs:540-614`). As a result, downstream systems cannot reproduce the original’s horizon, scenery, AI lines, or pit logic.
2. **Limited driver/car roster** – Only McLaren, Williams, and Ferrari entries are present, with six drivers total (`src/data/car.rs:212-288`). The original shipped with 18 teams/36 drivers and unique stats; replicating the DOS grid requires ingesting the full driver DB and team liveries.
3. **Asset availability** – The runtime assumes tracks are already extracted under `assets/original`, but the repository does not ship scripts or documentation for legally sourcing the full asset set beyond a manual ISO extractor. Tests skip silently when files are missing (`tests/track_loading.rs:6-55`), so CI cannot verify compatibility with real data.

### 3.2 Graphics & Presentation
1. **Lack of isometric renderer** – Track rendering simply connects section centers on the XY plane (`src/render/track_renderer.rs:37-118`), and cars render as filled circles (`src/render/car_renderer.rs:60-83`). The DOS version used pre-rendered isometric sprites, depth sorting, kerbs, horizon bitmaps, and animated pit-lane objects, none of which are recreated.
2. **Camera mismatch** – The camera stores Y as the vertical axis while physics uses Z for forward movement, so even the simplified top-down projection does not align with the actual world axes (e.g., `TrackRenderer::generate_track_points` pulls `position.y`, not `position.z`, at `src/render/track_renderer.rs:37-43`). A plan for matching the DOS viewing transformation is missing.
3. **Unintegrated 3D path** – The new `Renderer3D` loads a tessellated mesh but is not connected to gameplay and lacks AI car rendering (`src/render3d/renderer.rs:620-767`). There is no evidence of tile-based textures, dithered palette handling, or the original camera cuts, making “graphical fidelity” unachievable yet.

### 3.3 Handling, Physics, and Vehicle Systems
1. **RPM feedback loop broken** – Engine RPM is derived from rear-wheel speeds (`src/physics/car.rs:151-165`), but `wheel_speeds` never change after initialization (`src/physics/car.rs:74-103`), so shifting and engine output cannot match the real car’s behavior. Tires, clutch, and differential models from the original are absent.
2. **Surface/grip modeling is simplified** – `apply_surface_grip` multiplies the existing grip each frame without restoring a baseline (`src/physics/car.rs:346-359`), causing permanent grip loss whenever the car touches grass. There is no notion of kerb heights, wet/dry lines, or damage.
3. **Collision envelope** – `TrackCollision::check_collision` only measures radial distance from section centers and uses a constant half-width (`src/physics/collision.rs:52-101`). The original game had per-section verge widths, kerb types, and barriers; these parsed flags are ignored, so track limits and crash detection cannot mirror the DOS behavior.

### 3.4 AI, Drivers, and Race Control
1. **Placeholder racing lines and speeds** – Without the parsed racing-line segments, AI cars follow section centers and fixed 50 m/s targets (`src/ai/racing_line.rs:21-75`). Corner-specific braking, overtakes, and defensive logic from the original cannot emerge.
2. **Reduced grid size & personalities** – The race manager spawns at most five AI opponents using a small fixed array of personalities (`src/game/state.rs:226-263`). F1GP supported full 26-car grids and per-driver skill sliders; replicating that requires scaling the AI infrastructure and session management.
3. **Session logic gaps** – RaceSession only tracks lap counts and a simple countdown; there are no flag zones, pit strategies, mechanical failures, or weather transitions (`src/game/session.rs:7-312`).

### 3.5 Audio
1. **Procedural synthesis vs. sampled authenticity** – The SDL2 sound engine generates sawtooth/white-noise blends for engines, gearshifts, squeal, and collisions (`src/audio/sound_engine.rs:61-299`). The DOS game used pre-mixed samples and specific mixing behavior tied to the Sound Blaster/AdLib drivers. Matching the original timbre will require sample extraction/conversion or more faithful synthesis tuned to the recorded spectra.
2. **Missing music and environmental layers** – No module handles intro music, menu jingles, or crowd ambience. Only a single monaural channel is synthesized (`src/audio/sound_engine.rs:312-337`).

### 3.6 Controls & UX
1. **Keyboard-only input** – InputManager polls SDL2 keyboard state and maps WASD/arrow keys to throttle/brake/steer/shift (`src/game/input.rs:88-111`). The DOS version supported analog joysticks and multiple control schemes; there is no joystick/gamepad abstraction here.
2. **UI mismatch** – Menus and HUD render via a minimalist vector font (`src/platform/graphics.rs`) and no attempt is made to match the original’s layout, logos, or color palette. Pause overlays and track-select screens are text-only (`src/main.rs:48-425`).

### 3.7 Tooling, Testing, and Documentation
1. **Tests provide no assurance** – Integration tests skip when assets are missing and there are no unit tests for physics, AI, or rendering pipelines (`tests/track_loading.rs:20-55`).
2. **README overstates maturity** – The documentation promises a fully authentic, isometric renderer and complete audio system (`README.md:5-69`), which overpromises relative to the current implementation and can mislead contributors.

## 4. Recommendations
1. **Close the data gap first** – Implement deterministic DAT parsing: honor the offset table adjustments, decode racing lines, pit lanes, kerbs, objects, and camera definitions, and validate checksums. Add tooling/scripts to legally extract assets, plus regression tests that use sanitized fixtures.
2. **Rebuild the rendering pipeline** – Decide whether to recreate the DOS isometric renderer or adopt a faithful 3D recreation. Either way, replace the circle/line placeholders with sprite batches or textured meshes that pull real object data. Align coordinate systems across physics/camera to avoid the current XY/XZ mismatch.
3. **Reintegrate physics with vehicle data** – Update wheel-speed calculations, tire forces, and aero models to use parsed setup data. Model kerb heights, verge grip, and collision volumes from the track metadata so car handling and crashes align with the original.
4. **Expand AI and driver content** – Import the full driver roster and implement per-driver stat tables. Use parsed racing lines and section commands to derive braking points and overtakes. Scale RaceSession to the original field size and add authentic flag, pit, and failure logic.
5. **Audio authenticity** – Either extract the original sample set (engine loops, gear clunks, menus) or capture reference recordings to tune the procedural synth. Support stereo mixing and device selection akin to the original configuration.
6. **Controls & UX parity** – Add joystick/gamepad bindings, calibrations, and UI options similar to the DOS menus. Recreate the original HUD layout, fonts, and color palette for authenticity.
7. **Align documentation & tests** – Update the README to reflect actual progress and outline the remaining roadmap. Introduce automated tests (e.g., golden images for render output, parser fixtures, physics sanity checks) that do not require proprietary assets.

Focusing on these areas will move the project from its current prototype state toward the stated goal of a high-fidelity Geoff Crammond F1GP reimplementation.
