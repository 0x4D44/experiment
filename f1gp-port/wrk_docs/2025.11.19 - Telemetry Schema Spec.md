# 2025-11-19 – Telemetry Schema Specification

## Overview
Telemetry captures produced by `GameState` encode snapshots of every car (player + AI) at `~60 Hz` into the
`telemetry::TelemetryRecording` type. The file format is simply `bincode` serialization of the structure defined in
`src/telemetry/mod.rs`. This document clarifies units, ranges, and parity expectations.

## File Structure
```
TelemetryRecording {
  track_name: String,
  session_type: String,
  samples: Vec<TelemetrySample>,
}
```
Each `TelemetrySample` stores a single `(timestamp_ms, car_id)` pair with the following payload:

| Field | Type | Units / Notes |
|-------|------|---------------|
| `timestamp_ms` | `u64` | Milliseconds since recording start. Samples are appended per frame. |
| `car_id` | `u8` | 0 = player; AI cars increment from 1. Matches `RaceSession` ordering. |
| `position` | `[f32; 3]` | World-space meters (X right, Y up, Z forward). |
| `velocity` | `[f32; 3]` | m/s in world axes. |
| `acceleration` | `[f32; 3]` | m/s² in world axes. |
| `orientation` | `[f32; 4]` | Quaternion `(x, y, z, w)` in world space. |
| `speed` | `f32` | Magnitude of velocity in m/s. |
| `rpm` | `f32` | Engine RPM. |
| `gear` | `i8` | -1 reverse, 0 neutral, 1–6 forward ratios. |
| `throttle` | `f32` | Normalized [0, 1]. |
| `brake` | `f32` | Normalized [0, 1]. |
| `steering` | `f32` | Normalized [-1, 1], negative = left. |

## Serialization
- Encoding: `bincode` default configuration (little-endian). Files typically named `telemetry/<track>-<session>-<timestamp>.bin`.
- Binary size: `samples.len() * 88 bytes + metadata (~32 bytes per string)`. A 5-minute session with 2 cars ≈ 60 MB.
- Compatibility: changes to `TelemetrySample` require bumping `telemetry::VERSION` (future field) and conversion tooling.

## Tooling
- `tools/telemetry_cli` reads `.bin` files, prints summaries, exports JSON/CSV for analysis, and filters by car ID. Example:
  ```bash
  cargo run -p telemetry_cli -- summary --input telemetry/monaco-practice-1732000000.bin --verbose
  cargo run -p telemetry_cli -- export-json --input ... --output exports/monaco.json --pretty
  cargo run -p telemetry_cli -- export-csv --input ... --output exports/monaco.csv --car 0
  ```
- JSON exports mirror the `TelemetryRecording` struct. CSV uses one row per sample with positional/controls columns.

## Parity Workflow
1. Capture telemetry in both DOS (via serial logger) and Rust ports for the same scenario.
2. Convert Rust captures to CSV with `telemetry_cli` and DOS logs via the DOS tooling.
3. Feed both into the parity harness (to be implemented) to compare lap times, speed traces, and control inputs.
4. Flag drift if average speed delta >1% or positional error exceeds configured thresholds.

## Acceptance Criteria (Plan Task 1.7)
- Schema documented (this file).
- Serializer/deserializer tests exist (`src/telemetry/mod.rs`).
- CLI available for converting/inspecting captures (`tools/telemetry_cli`).
