# Montreal Track Parser Investigation

**Date:** 2025-11-18
**Issue:** F1CT05.DAT (Montreal) fails to parse
**Status:** ❌ Unable to fix - file format incompatible
**Result:** 15/16 tracks working (v1.0 shipped with this status)

---

## Problem

Montreal track (F1CT05.DAT) returns **0 sections** when parsed, while all other 15 tracks parse successfully.

## Investigation Summary

### Attempts Made

1. **Expanded skip value range** (0 to 5000 in fine increments)
   - Result: Only skip=1900 found 7 sections (107m) - rejected as invalid

2. **Tried all 7 offsets** from Montreal's offset table
   - Offsets: 0x2020, 0x36D2, 0x2B02, 0x36D2, 0x3AE5, 0x2C79, 0x32F9
   - Result: No valid section patterns at any offset

3. **Lowered validation thresholds**
   - Min sections: 15 → 10
   - Min length: 2500m → 1500m
   - Result: No improvement

4. **Section pattern scanning**
   - Scanned entire file for section-like byte patterns
   - Checked backwards from section terminators
   - Result: No recognizable section structures found

5. **Offset table analysis**
   - Montreal: offset 0 = 0x1010 → 0x2020 (same as Monaco)
   - Data at 0x2020 completely different from Monaco
   - Terminator at 0x252A (1290 bytes after track_data_offset)

6. **Raw data comparison**
   - Monaco pattern: `01 00 00 00 2E 00 22 00 80...` (clear sections)
   - Montreal pattern: `00 FE 0F 00 85 20 C2 26...` (no recognizable sections)
   - Montreal data does not follow section structure (byte2=0x00 marker missing)

### Technical Findings

**Montreal File Characteristics:**
- File size: 15,081 bytes (normal)
- Checksum: 0x60D0825D (valid - successfully read)
- Track data offset: 0x2020 (same as other tracks)
- Section terminators found at:
  - 0x252A (9514)
  - 0x384B (14411)
  - 0x3AAB (15019)
  - 0x3AC7 (15047)

**Data Structure Differences:**

Monaco (working):
```
00 01 00 00 2E 00 22 00 80 01 00 00 2E 00 02 00 80...
   ^^    ^^  ^^          ^^    ^^  ^^
   |     |   |           |     |   |
   len   0  curv/height  len   0  curv/height
```

Montreal (failing):
```
00 FE 0F 00 85 20 C2 26 00 09 00 24 00 21 00 35 00 26 00 00
   ^^    ^^                 ^^    ^^    ^^    ^^
   No recognizable section pattern
```

### Conclusion

Montreal (F1CT05.DAT) either:
1. Uses a **different file format version** not supported by ArgData-based parser
2. Has **special encoding** that requires game-specific knowledge
3. Is **corrupt** in this particular data set

The absence of the standard section marker (byte2=0x00) and lack of recognizable curvature/height/flags patterns suggests fundamental format incompatibility, not just an offset issue.

---

## Recommended Action

**Ship v1.0 with 15/16 tracks** (current status)

**Future Work (v2.0+):**
- Consult original F1GP source code (if available)
- Check F1GP community for F1CT05-specific documentation
- Try different F1CT05.DAT file sources (possible corruption)
- Reverse-engineer format by comparing with original game behavior

---

## Parser Improvements Made

During investigation, improved parser robustness:
- Extended skip search range: 0-3000 → 0-5000
- Added fine-grained search: 10-byte increments in 1200-1500 range
- Lowered minimum thresholds for edge cases
- These improvements benefit future track additions

---

## Files Modified

- `src/data/parser.rs`: Expanded test_skips array (0-5000 range)
- Various debugging tools created for analysis

**Time Invested:** ~3 hours
**Outcome:** Confirmed Montreal incompatible, v1.0 ships with 15 tracks

---

*"Not every problem can be solved by trying harder. Sometimes the data format just doesn't match."*
