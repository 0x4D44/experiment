# Code Coverage Improvement Plan
**Project:** jrnrvw
**Date:** 2025.11.13
**Current Coverage:** 77.30%
**Target Coverage:** 98.00%
**Gap:** 20.70 percentage points

---

## Executive Summary

This plan outlines a systematic, multistage approach to improve code coverage from **77.30% to 98.00%**. The plan prioritizes high-impact changes and is organized into 6 stages that progressively address critical gaps.

**Total Lines to Cover:** 448 lines
**Estimated New Tests:** 40-50 tests
**Estimated Duration:** 2-3 hours

---

## Stage 0: Preparation and Setup

**Duration:** 10 minutes
**Impact:** Infrastructure for all subsequent stages

### Tasks

- [x] Install coverage tools (cargo-llvm-cov)
- [x] Run initial coverage analysis
- [x] Document current state
- [ ] Create test fixtures directory structure
- [ ] Set up integration test helpers

### Deliverables

- Coverage baseline report
- Test fixture infrastructure
- Helper functions for integration tests

---

## Stage 1: Critical Integration Tests (Main + Discovery)

**Duration:** 30-40 minutes
**Lines to Cover:** 163 lines
**Expected Coverage After:** 83.65% â†’ 84.85%
**Priority:** CRITICAL

### Rationale

The main application and discovery integration are completely untested (0% coverage). These are the highest-impact targets as they verify the entire application works end-to-end.

### 1.1 Integration Tests for main.rs

**File:** `tests/integration/cli_tests.rs`

**Tests to Add:**

1. **test_basic_usage**
   - Run jrnrvw on sample journals
   - Verify text output contains expected data
   - **Lines covered:** ~20

2. **test_json_output_format**
   - Run with `--format json`
   - Parse and validate JSON structure
   - **Lines covered:** ~15

3. **test_markdown_output_format**
   - Run with `--format markdown`
   - Verify markdown headers and structure
   - **Lines covered:** ~15

4. **test_csv_output_format**
   - Run with `--format csv`
   - Verify CSV headers and data
   - **Lines covered:** ~15

5. **test_html_output_format**
   - Run with `--format html`
   - Verify HTML tags present
   - **Lines covered:** ~15

6. **test_output_to_file**
   - Test `-o output.txt`
   - Verify file created with content
   - **Lines covered:** ~10

7. **test_verbose_mode**
   - Test `-v` flag
   - Verify verbose output to stderr
   - **Lines covered:** ~5

8. **test_quiet_mode**
   - Test `-q` flag
   - Verify minimal output
   - **Lines covered:** ~5

9. **test_filter_by_repo**
   - Test `--repo "pattern"`
   - Verify filtering works
   - **Lines covered:** ~10

10. **test_filter_by_task**
    - Test `--task "pattern"`
    - Verify filtering works
    - **Lines covered:** ~10

11. **test_no_journals_found**
    - Test with empty directory
    - Verify user-friendly message
    - **Lines covered:** ~5

12. **test_invalid_path**
    - Test with non-existent directory
    - Verify error handling
    - **Lines covered:** ~5

13. **test_with_activities_flag**
    - Test `--with-activities`
    - Verify activities included in output
    - **Lines covered:** ~5

14. **test_with_notes_flag**
    - Test `--with-notes`
    - Verify notes included
    - **Lines covered:** ~5

15. **test_summary_mode**
    - Test `--summary`
    - Verify summary-only output
    - **Lines covered:** ~5

**Subtotal:** ~145 lines (main.rs + integration overhead)

### 1.2 Integration Tests for discovery/mod.rs

**File:** `tests/integration/discovery_integration_tests.rs`

**Tests to Add:**

1. **test_discover_journals_with_files**
   - Create temp dir with journal files
   - Call `discover_journals()`
   - Verify entries returned
   - **Lines covered:** ~10

2. **test_discover_journals_empty_directory**
   - Empty temp dir
   - Verify empty vector returned
   - **Lines covered:** ~5

3. **test_discover_journals_with_excludes**
   - Create journals in excluded dirs
   - Verify they're not discovered
   - **Lines covered:** ~5

4. **test_discover_journals_invalid_dates**
   - Create files with invalid date formats
   - Verify they're skipped gracefully
   - **Lines covered:** ~5

**Subtotal:** ~26 lines

### 1.3 CLI Parser Tests

**File:** `src/cli.rs` (add inline tests)

**Tests to Add:**

1. **test_parse_date_valid**
   - Test date parsing function
   - **Lines covered:** ~3

2. **test_parse_date_invalid**
   - Test error handling
   - **Lines covered:** ~2

**Subtotal:** ~5 lines

### Stage 1 Deliverables

- âœ… 17 integration tests
- âœ… Main application tested end-to-end
- âœ… Discovery pipeline validated
- âœ… Coverage improvement: +7.55%

---

## Stage 2: Analyzer Module Completion

**Duration:** 30-40 minutes
**Lines to Cover:** 135 lines
**Expected Coverage After:** 91.10%
**Priority:** HIGH

### 2.1 TimeRange Filter Tests

**File:** `src/analyzer/filter.rs` (extend tests)

**Tests to Add:**

1. **test_time_range_to_date_range_last_week**
   - Test LastWeek conversion
   - **Lines covered:** ~5

2. **test_time_range_to_date_range_last_month**
   - Test LastMonth conversion
   - **Lines covered:** ~5

3. **test_time_range_to_date_range_this_week**
   - Test ThisWeek (Monday-Sunday)
   - **Lines covered:** ~10

4. **test_time_range_to_date_range_this_month**
   - Test ThisMonth (first-last day)
   - **Lines covered:** ~10

5. **test_time_range_includes_date**
   - Test date inclusion logic
   - **Lines covered:** ~5

6. **test_activity_days_filtering**
   - Test ActivityDays enum
   - **Lines covered:** ~10

7. **test_filter_by_time_range_custom**
   - Test custom date range
   - **Lines covered:** ~5

8. **test_filter_by_time_range_since**
   - Test Since variant
   - **Lines covered:** ~5

9. **test_filter_by_time_range_before**
   - Test Before variant
   - **Lines covered:** ~5

10. **test_combined_filters**
    - Test repo + task + time filters together
    - **Lines covered:** ~7

**Subtotal:** ~67 lines

### 2.2 Grouper Tests

**File:** `src/analyzer/grouper.rs` (extend tests)

**Tests to Add:**

1. **test_group_by_date**
   - Group entries by exact date
   - **Lines covered:** ~15

2. **test_group_by_week**
   - Group by week number
   - **Lines covered:** ~15

3. **test_group_by_month**
   - Group by month
   - **Lines covered:** ~15

4. **test_sort_by_repository_name**
   - Test alphabetical repo sorting
   - **Lines covered:** ~8

5. **test_sort_by_task_name**
   - Test alphabetical task sorting
   - **Lines covered:** ~8

6. **test_reverse_sorting**
   - Test reverse flag
   - **Lines covered:** ~7

**Subtotal:** ~68 lines

### Stage 2 Deliverables

- âœ… 16 analyzer tests
- âœ… All TimeRange variants covered
- âœ… All grouping strategies tested
- âœ… Coverage improvement: +6.25%

---

## Stage 3: Output Formatter Enhancements

**Duration:** 20-30 minutes
**Lines to Cover:** 73 lines
**Expected Coverage After:** 94.48%
**Priority:** MEDIUM

### 3.1 Text Formatter Tests

**File:** `src/output/text.rs` (extend tests)

**Tests to Add:**

1. **test_text_formatting_with_color**
   - Test colored output
   - **Lines covered:** ~8

2. **test_text_formatting_verbose_mode**
   - Test verbose with activities
   - **Lines covered:** ~8

3. **test_text_formatting_with_notes**
   - Test notes inclusion
   - **Lines covered:** ~5

**Subtotal:** ~21 lines

### 3.2 Markdown Formatter Tests

**File:** `src/output/markdown.rs` (extend tests)

**Tests to Add:**

1. **test_markdown_verbose_mode**
   - Test detailed task listings
   - **Lines covered:** ~13

2. **test_markdown_with_activities**
   - Test activity inclusion
   - **Lines covered:** ~8

3. **test_markdown_with_notes**
   - Test notes section
   - **Lines covered:** ~5

**Subtotal:** ~26 lines

### 3.3 JSON Formatter Tests

**File:** `src/output/json.rs` (extend tests)

**Tests to Add:**

1. **test_json_with_all_fields**
   - Test complete serialization
   - **Lines covered:** ~5

**Subtotal:** ~5 lines

### 3.4 HTML Formatter Tests

**File:** `src/output/html.rs` (extend tests)

**Tests to Add:**

1. **test_html_with_multiple_repos**
   - Test complex HTML structure
   - **Lines covered:** ~6

**Subtotal:** ~6 lines

### 3.5 CSV Formatter Tests

**File:** `src/output/csv.rs` (extend tests)

**Tests to Add:**

1. **test_csv_with_special_characters**
   - Test proper escaping
   - **Lines covered:** ~5

2. **test_tsv_format**
   - Test format_as_tsv()
   - **Lines covered:** ~5

3. **test_csv_error_paths**
   - Test error handling
   - **Lines covered:** ~5

**Subtotal:** ~15 lines

### Stage 3 Deliverables

- âœ… 10 output tests
- âœ… All formatters tested with options
- âœ… Coverage improvement: +3.38%

---

## Stage 4: Configuration and Helpers

**Duration:** 15-20 minutes
**Lines to Cover:** 33 lines
**Expected Coverage After:** 95.98%
**Priority:** MEDIUM

### 4.1 Configuration Tests

**File:** `src/config/settings.rs` (extend tests)

**Tests to Add:**

1. **test_load_from_file_success**
   - Create temp TOML file
   - Test successful load
   - **Lines covered:** ~8

2. **test_load_from_file_invalid_toml**
   - Test TOML parsing error
   - **Lines covered:** ~5

3. **test_load_default_project_level**
   - Test `./.jrnrvw.toml` loading
   - **Lines covered:** ~4

4. **test_load_default_user_level**
   - Test `~/.jrnrvw.toml` loading
   - **Lines covered:** ~4

**Subtotal:** ~21 lines

### 4.2 Model Helper Tests

**File:** `src/models/journal.rs` (extend tests)

**Tests to Add:**

1. **test_description_with_title**
   - Test title priority
   - **Lines covered:** ~3

2. **test_description_with_task**
   - Test task fallback
   - **Lines covered:** ~3

3. **test_description_untitled**
   - Test default value
   - **Lines covered:** ~3

4. **test_matches_task**
   - Test task matching
   - **Lines covered:** ~3

**Subtotal:** ~12 lines

### Stage 4 Deliverables

- âœ… 8 configuration/helper tests
- âœ… Config loading validated
- âœ… Helper methods covered
- âœ… Coverage improvement: +1.53%

---

## Stage 5: Error Paths and Edge Cases

**Duration:** 15-20 minutes
**Lines to Cover:** 44 lines
**Expected Coverage After:** 98.05%
**Priority:** MEDIUM-LOW

### 5.1 Error Path Tests

Tests to trigger error branches:

1. **test_csv_write_error** (csv.rs)
   - Force CSV write failure
   - **Lines covered:** ~5

2. **test_json_serialization_edge_cases** (json.rs)
   - Test unusual data
   - **Lines covered:** ~3

3. **test_config_file_not_found** (config/settings.rs)
   - Test file read error
   - **Lines covered:** ~3

4. **test_invalid_regex_in_filter** (analyzer/filter.rs)
   - Test regex compilation error
   - **Lines covered:** ~5

5. **test_parser_invalid_markdown** (parser/journal.rs)
   - Test malformed markdown
   - **Lines covered:** ~8

6. **test_stats_with_empty_data** (analyzer/stats.rs)
   - Test edge cases
   - **Lines covered:** ~8

7. **test_repository_no_parent** (discovery/repo_detector.rs)
   - Test root directory case
   - **Lines covered:** ~2

8. **test_scanner_permission_denied** (discovery/scanner.rs)
   - Test directory access error
   - **Lines covered:** ~2

9. **test_report_builder_validation** (analyzer/report_builder.rs)
   - Test error conditions
   - **Lines covered:** ~8

**Subtotal:** ~44 lines

### Stage 5 Deliverables

- âœ… 9 error path tests
- âœ… All error branches covered
- âœ… Coverage improvement: +2.07%
- âœ… **TARGET REACHED: 98.05%**

---

## Stage 6: Maintenance and Documentation

**Duration:** 10 minutes
**Priority:** LOW

### Tasks

- [ ] Update journal with coverage improvements
- [ ] Run final coverage report
- [ ] Document any remaining uncovered lines (if <98%)
- [ ] Add coverage badge to README
- [ ] Set up CI coverage reporting (optional)

### Deliverables

- Final coverage report
- Updated documentation
- Maintainable test suite

---

## Implementation Order

### Priority Queue

1. âœ… **Stage 1** - Critical integration tests (main.rs, discovery)
   - Highest impact: +7.55%
   - Validates entire application works

2. âœ… **Stage 2** - Analyzer completion (filter, grouper)
   - High impact: +6.25%
   - Tests core business logic

3. âœ… **Stage 3** - Output formatters
   - Medium impact: +3.38%
   - Tests user-facing features

4. âœ… **Stage 4** - Configuration and helpers
   - Medium impact: +1.53%
   - Tests supporting features

5. âœ… **Stage 5** - Error paths
   - Final push: +2.07%
   - Achieves 98% target

6. âœ… **Stage 6** - Documentation
   - Maintenance
   - Ensures sustainability

---

## Success Criteria

- âœ… Line coverage â‰¥ 98.00%
- âœ… All critical paths tested (main, discovery, analyzer)
- âœ… All public APIs have tests
- âœ… Integration tests verify end-to-end workflows
- âœ… Error handling tested
- âœ… CI/CD can run coverage automatically
- âœ… Tests are maintainable and well-documented

---

## Risk Mitigation

### Risk 1: Integration Tests Are Complex

**Mitigation:**
- Use `assert_cmd` for simple CLI testing
- Create reusable test fixtures
- Use helper functions to reduce boilerplate

### Risk 2: Some Code May Be Hard to Cover

**Mitigation:**
- Focus on reachable code first
- Document intentionally uncovered code
- May need refactoring for testability

### Risk 3: Time Constraints

**Mitigation:**
- Prioritize by impact (Stages 1-2 first)
- Stage 5 can be skipped if time runs out
- 95%+ is still excellent

---

## Metrics and Tracking

### Coverage Checkpoints

| Stage | Expected Coverage | Actual Coverage | Status |
|-------|------------------|-----------------|--------|
| Start | 77.30% | 77.30% | âœ… |
| Stage 1 | 84.85% | TBD | â³ |
| Stage 2 | 91.10% | TBD | â³ |
| Stage 3 | 94.48% | TBD | â³ |
| Stage 4 | 95.98% | TBD | â³ |
| Stage 5 | 98.05% | TBD | â³ |
| Target | 98.00% | TBD | ðŸŽ¯ |

### Test Count Tracking

| Stage | Tests Added | Cumulative Tests |
|-------|-------------|------------------|
| Current | 0 | 68 |
| Stage 1 | 17 | 85 |
| Stage 2 | 16 | 101 |
| Stage 3 | 10 | 111 |
| Stage 4 | 8 | 119 |
| Stage 5 | 9 | 128 |
| **Total** | **60** | **128** |

---

## Conclusion

This plan provides a systematic approach to improving code coverage from 77.30% to 98.00%. By prioritizing integration tests first, then completing analyzer coverage, and finally addressing edge cases, we ensure the most critical code is tested thoroughly.

The plan is aggressive but achievable within a single focused session (2-3 hours). Each stage delivers incremental value and can be implemented independently.

**Next Step:** Begin Stage 1 implementation.

---

**Plan Status:** Ready for implementation
**Estimated Completion:** Within current session
**Success Probability:** High (straightforward tasks, clear targets)
