# Code Coverage Improvement Plan
## eBay MCP Server - Path to 98% Coverage

**Date:** 2025-11-14
**Current Coverage:** 29.73%
**Target Coverage:** 98%
**Gap:** 68.27%

---

## Overview

This document outlines a **4-phase systematic approach** to achieve 98% code coverage for the eBay MCP Server. Each phase builds upon the previous, focusing on different aspects of the codebase.

### Phase Summary

| Phase | Target Coverage | Focus Area | Estimated Tests |
|-------|----------------|------------|-----------------|
| **Phase 1** | 50% | Critical Foundation | 40 tests |
| **Phase 2** | 75% | Core Business Logic | 50 tests |
| **Phase 3** | 90% | Edge Cases & Integration | 35 tests |
| **Phase 4** | 98% | Comprehensive Coverage | 35 tests |

**Total Estimated:** ~160 new tests

---

## Phase 1: Critical Foundation (29% → 50%)

**Goal:** Establish test infrastructure and cover critical server components

### Objectives
1. Set up comprehensive test infrastructure
2. Test server initialization and basic request handling
3. Add search manager core tests
4. Improve scraper coverage

### Tasks

#### 1.1 Test Infrastructure Enhancement
- [ ] Create `tests/integration/` directory structure
- [ ] Add mock browser implementation in `tests/common/mocks.rs`
- [ ] Add async test utilities in `tests/common/helpers.rs`
- [ ] Create database test fixtures with in-memory SQLite
- [ ] Add test configuration builder

**Files to modify:**
- `tests/common/mocks.rs` - Add MockBrowser, MockDatabase
- `tests/common/helpers.rs` - Add async test helpers
- `tests/integration/mod.rs` - New integration test module

#### 1.2 Search Manager Tests (0% → 60%)
**Target file:** `src/search/manager.rs`

Tests to add:
- [ ] `test_search_manager_creation` - Basic instantiation
- [ ] `test_search_with_cache_hit` - Cache retrieval
- [ ] `test_search_with_cache_miss` - Fresh search execution
- [ ] `test_search_with_filters` - Filter application
- [ ] `test_search_error_handling` - Error propagation
- [ ] `test_save_search_phrase` - Phrase saving
- [ ] `test_get_saved_phrases` - Phrase retrieval
- [ ] `test_search_history_recording` - History tracking

**New test file:** `src/search/manager.rs` (in `#[cfg(test)]` mod tests)

#### 1.3 Server Core Tests (0% → 40%)
**Target file:** `src/server/server.rs`

Tests to add:
- [ ] `test_server_initialization` - Server startup
- [ ] `test_server_initialization_error` - Init error handling
- [ ] `test_initialize_request` - Protocol initialization
- [ ] `test_list_tools_request` - Tool listing
- [ ] `test_list_resources_request` - Resource listing
- [ ] `test_call_tool_search_ebay` - Search tool execution
- [ ] `test_invalid_request_handling` - Malformed requests
- [ ] `test_server_shutdown` - Clean shutdown

**New test file:** `tests/integration/server_tests.rs`

#### 1.4 Scraper Enhancement (48.95% → 70%)
**Target file:** `src/scraper/ebay.rs`

Additional tests needed:
- [ ] `test_scrape_search_results_full_flow` - End-to-end scraping
- [ ] `test_parse_listing_with_shipping` - Shipping parsing
- [ ] `test_parse_listing_auction_format` - Auction listings
- [ ] `test_parse_empty_results` - No results handling
- [ ] `test_extract_total_count_variations` - Count parsing
- [ ] `test_handle_malformed_html` - Error cases
- [ ] `test_handle_missing_elements` - Partial data
- [ ] `test_pagination_url_building` - Pagination logic

**Files:** `src/scraper/ebay.rs` (in `#[cfg(test)]` mod tests)

#### 1.5 Browser Pool Tests (30.98% → 50%)
**Target file:** `src/browser/pool.rs`

Tests to add:
- [ ] `test_pool_initialization` - Pool startup
- [ ] `test_acquire_browser_instance` - Instance allocation
- [ ] `test_release_browser_instance` - Instance return
- [ ] `test_pool_size_limits` - Max instances
- [ ] `test_instance_reuse` - Instance recycling
- [ ] `test_initialization_error_handling` - Startup errors

**New test file:** `src/browser/pool.rs` (in `#[cfg(test)]` mod tests)

### Phase 1 Success Criteria
- ✓ Coverage reaches 50%
- ✓ All critical initialization paths tested
- ✓ Search manager core functionality covered
- ✓ Basic server request/response cycle working
- ✓ Mock infrastructure in place

---

## Phase 2: Core Business Logic (50% → 75%)

**Goal:** Complete testing of core business functionality

### Objectives
1. Full coverage of tool handlers
2. Complete resource handlers
3. Full cache implementation testing
4. Complete configuration management

### Tasks

#### 2.1 Tool Handler Tests (0% → 95%)
**Target file:** `src/server/tools.rs`

Tests to add:
- [ ] `test_handle_search_ebay_tool` - Search tool
- [ ] `test_handle_search_ebay_with_filters` - Filtered search
- [ ] `test_handle_get_saved_phrases_tool` - Saved phrases tool
- [ ] `test_handle_save_phrase_tool` - Save phrase tool
- [ ] `test_handle_delete_phrase_tool` - Delete phrase tool
- [ ] `test_handle_get_search_history_tool` - History tool
- [ ] `test_handle_clear_cache_tool` - Cache clearing
- [ ] `test_invalid_tool_name` - Unknown tool error
- [ ] `test_missing_required_arguments` - Argument validation
- [ ] `test_invalid_argument_types` - Type validation
- [ ] `test_tool_execution_errors` - Error handling
- [ ] `test_concurrent_tool_calls` - Concurrency

**New test file:** `tests/integration/tool_handler_tests.rs`

#### 2.2 Resource Handler Tests (0% → 95%)
**Target file:** `src/server/resources.rs`

Tests to add:
- [ ] `test_handle_list_resources` - Resource listing
- [ ] `test_handle_read_config_resource` - Config resource
- [ ] `test_handle_read_stats_resource` - Stats resource
- [ ] `test_invalid_resource_uri` - Invalid URIs
- [ ] `test_resource_error_handling` - Error cases
- [ ] `test_resource_content_formatting` - Content format

**New test file:** `tests/integration/resource_handler_tests.rs`

#### 2.3 Cache Tests (0% → 95%)
**Target file:** `src/storage/cache.rs`

Tests to add:
- [ ] `test_cache_creation` - Initialization
- [ ] `test_cache_get_hit` - Cache hit
- [ ] `test_cache_get_miss` - Cache miss
- [ ] `test_cache_set` - Setting values
- [ ] `test_cache_expiration` - TTL expiration
- [ ] `test_cache_eviction_lru` - LRU eviction
- [ ] `test_cache_max_entries` - Size limits
- [ ] `test_cache_clear` - Cache clearing
- [ ] `test_cache_stats` - Statistics
- [ ] `test_cache_key_generation` - Key hashing
- [ ] `test_cache_disabled` - Disabled mode
- [ ] `test_concurrent_access` - Thread safety

**New test file:** `src/storage/cache.rs` (in `#[cfg(test)]` mod tests)

#### 2.4 Configuration Tests (36.88% → 90%)
**Target file:** `src/config/mod.rs`

Additional tests:
- [ ] `test_config_from_file` - File loading
- [ ] `test_config_from_env` - Environment variables
- [ ] `test_config_defaults` - Default values
- [ ] `test_config_validation` - Invalid configs
- [ ] `test_config_hot_reload` - File watching
- [ ] `test_config_reload_error_handling` - Reload errors
- [ ] `test_config_concurrent_access` - Thread safety
- [ ] `test_config_merge_sources` - Multi-source merging

**Files:** `src/config/mod.rs` (in `#[cfg(test)]` mod tests)

#### 2.5 Protocol Tests (0% → 95%)
**Target file:** `src/server/protocol.rs`

Tests to add:
- [ ] `test_serialize_initialize_request` - Request serialization
- [ ] `test_deserialize_initialize_response` - Response parsing
- [ ] `test_serialize_call_tool_request` - Tool requests
- [ ] `test_deserialize_tool_response` - Tool responses
- [ ] `test_error_response_serialization` - Error responses
- [ ] `test_protocol_versioning` - Version handling

**New test file:** `src/server/protocol.rs` (in `#[cfg(test)]` mod tests)

### Phase 2 Success Criteria
- ✓ Coverage reaches 75%
- ✓ All tool handlers fully tested
- ✓ Resource handlers complete
- ✓ Cache operations verified
- ✓ Configuration management robust

---

## Phase 3: Edge Cases & Integration (75% → 90%)

**Goal:** Test error paths, edge cases, and integration scenarios

### Objectives
1. Comprehensive error handling tests
2. Integration test suites
3. Concurrency and race condition tests
4. Performance edge cases

### Tasks

#### 3.1 Error Path Testing
- [ ] Network timeout scenarios
- [ ] Browser crash recovery
- [ ] Database connection failures
- [ ] Disk full scenarios
- [ ] Invalid HTML parsing
- [ ] CAPTCHA detection
- [ ] Rate limiting responses
- [ ] Memory pressure scenarios

**New test file:** `tests/integration/error_scenarios_tests.rs`

#### 3.2 Integration Test Suites

**Full search flow:**
- [ ] `test_full_search_flow_cache_miss` - Complete search cycle
- [ ] `test_full_search_flow_cache_hit` - Cached results
- [ ] `test_concurrent_searches_same_query` - Deduplication
- [ ] `test_concurrent_searches_different_queries` - Parallel execution

**Server lifecycle:**
- [ ] `test_server_startup_shutdown_cycle` - Full lifecycle
- [ ] `test_server_multiple_requests` - Request handling
- [ ] `test_server_request_timeout` - Timeout handling
- [ ] `test_server_graceful_shutdown_with_active_requests` - Clean shutdown

**Storage integration:**
- [ ] `test_database_cache_interaction` - DB + Cache
- [ ] `test_search_history_persistence` - History storage
- [ ] `test_saved_phrases_crud` - Phrase CRUD operations

**New test file:** `tests/integration/full_flow_tests.rs`

#### 3.3 Browser Management Edge Cases
- [ ] `test_browser_pool_exhaustion` - No available instances
- [ ] `test_browser_instance_timeout` - Stuck instances
- [ ] `test_browser_crash_handling` - Crash recovery
- [ ] `test_browser_pool_cleanup` - Resource cleanup
- [ ] `test_browser_initialization_failures` - Init errors
- [ ] `test_concurrent_browser_acquisition` - Race conditions

**Files:** `src/browser/pool.rs` (additional tests)

#### 3.4 Database Edge Cases (74.71% → 95%)
- [ ] `test_database_migration` - Schema migration
- [ ] `test_database_transaction_rollback` - Rollback
- [ ] `test_database_concurrent_writes` - Write conflicts
- [ ] `test_database_connection_pool_exhaustion` - Pool limits
- [ ] `test_database_corruption_handling` - Corruption detection

**Files:** `src/storage/database.rs` (additional tests)

#### 3.5 Anti-Detection Edge Cases (70.49% → 95%)
- [ ] `test_user_agent_rotation` - UA rotation
- [ ] `test_viewport_randomization_distribution` - Viewport variety
- [ ] `test_delay_randomization_distribution` - Delay patterns
- [ ] `test_stealth_mode_headers` - Header manipulation

**Files:** `src/browser/anti_detection.rs` (additional tests)

#### 3.6 Model Tests (18.18% → 95%)
**Target files:** `src/models/*.rs`

- [ ] `test_search_filters_serialization` - Serde
- [ ] `test_search_filters_validation` - Invalid filters
- [ ] `test_listing_price_parsing` - Price formats
- [ ] `test_listing_serialization` - JSON output
- [ ] `test_config_model_defaults` - Default values
- [ ] `test_config_model_validation` - Validation logic

**Files:** `src/models/*.rs` (in `#[cfg(test)]` mod tests)

### Phase 3 Success Criteria
- ✓ Coverage reaches 90%
- ✓ All error paths tested
- ✓ Integration scenarios verified
- ✓ Concurrency issues addressed
- ✓ Edge cases documented

---

## Phase 4: Comprehensive Coverage (90% → 98%)

**Goal:** Achieve 98% coverage through exhaustive testing

### Objectives
1. Test remaining uncovered lines
2. Add property-based tests where applicable
3. Test documentation examples
4. Cleanup and optimization

### Tasks

#### 4.1 Remaining Coverage Gaps
- [ ] Review coverage report line-by-line
- [ ] Identify specific uncovered branches
- [ ] Add targeted tests for each gap
- [ ] Test error message formatting
- [ ] Test debug output
- [ ] Test logging statements

#### 4.2 Property-Based Testing
- [ ] Search query generation - valid inputs always work
- [ ] Filter combinations - all valid combos work
- [ ] Price parsing - all valid price formats parse
- [ ] URL encoding - all queries encode properly

**Dependencies:** Add `proptest` or `quickcheck` crate

#### 4.3 Documentation Example Tests
- [ ] Test all examples in README.md
- [ ] Test code examples in doc comments
- [ ] Verify configuration examples
- [ ] Test API usage examples

#### 4.4 Logging and Utility Tests (0% → 95%)
**Target file:** `src/utils/logging.rs`

- [ ] `test_logging_initialization` - Logger setup
- [ ] `test_log_level_configuration` - Level setting
- [ ] `test_json_logging_format` - JSON output
- [ ] `test_logging_to_file` - File logging

**Files:** `src/utils/logging.rs` (in `#[cfg(test)]` mod tests)

#### 4.5 Performance and Stress Tests
- [ ] Large result set handling (10,000+ items)
- [ ] Memory usage under load
- [ ] Cache performance with many entries
- [ ] Database query performance
- [ ] Concurrent request load testing

**New test file:** `tests/integration/performance_tests.rs`

#### 4.6 Final Coverage Polish
- [ ] Run coverage report
- [ ] Identify lines at <98%
- [ ] Add specific tests for gaps
- [ ] Test unreachable!() and panic!() paths
- [ ] Test deprecated code paths (if any)
- [ ] Test feature flag combinations

### Phase 4 Success Criteria
- ✓ **Coverage reaches 98%**
- ✓ All public APIs tested
- ✓ Documentation examples verified
- ✓ Performance baseline established
- ✓ Technical debt addressed

---

## Implementation Guidelines

### Test Organization

```
ebay-mcp/
├── src/
│   └── **/*.rs           # Unit tests in #[cfg(test)] mod tests
├── tests/
│   ├── common/
│   │   ├── mod.rs
│   │   ├── fixtures.rs   # Test data builders
│   │   ├── helpers.rs    # Test utilities
│   │   └── mocks.rs      # Mock implementations
│   └── integration/
│       ├── mod.rs
│       ├── server_tests.rs
│       ├── tool_handler_tests.rs
│       ├── resource_handler_tests.rs
│       ├── full_flow_tests.rs
│       ├── error_scenarios_tests.rs
│       └── performance_tests.rs
```

### Test Naming Conventions

```rust
#[test]
fn test_<component>_<scenario>_<expected_outcome>() {
    // Example: test_cache_get_miss_returns_none
}

#[tokio::test]
async fn test_async_<component>_<scenario>() {
    // For async tests
}
```

### Mock Strategy

1. **Browser Mocking:** Create `MockBrowser` that returns pre-configured HTML
2. **Database Mocking:** Use in-memory SQLite for tests
3. **Config Mocking:** Use `tempfile` for config file testing
4. **Network Mocking:** Mock HTTP responses for error simulation

### Code Coverage Measurement

Run coverage after each phase:
```bash
cargo llvm-cov --lib --tests --json --output-path ./target/coverage/coverage.json
cargo llvm-cov --lib --tests
```

### Quality Standards

Each test must:
- ✓ Have a clear, descriptive name
- ✓ Test one specific behavior
- ✓ Be independent (no test order dependencies)
- ✓ Clean up resources (tempfiles, connections)
- ✓ Use fixtures for complex setup
- ✓ Assert expected outcomes explicitly

---

## Risk Mitigation

### Potential Challenges

1. **Async Testing Complexity**
   - **Mitigation:** Use `tokio-test` helpers, wrap in runtime

2. **Browser Mocking Difficulty**
   - **Mitigation:** Create trait abstraction for browser interface

3. **Database Test Isolation**
   - **Mitigation:** Use separate in-memory DB per test

4. **Flaky Integration Tests**
   - **Mitigation:** Proper cleanup, avoid time-based assertions

5. **Long Test Execution Time**
   - **Mitigation:** Parallelize tests, use `cargo-nextest`

---

## Progress Tracking

### Checkpoints

- [ ] **Phase 1 Complete** - Coverage ≥50%
- [ ] **Phase 2 Complete** - Coverage ≥75%
- [ ] **Phase 3 Complete** - Coverage ≥90%
- [ ] **Phase 4 Complete** - Coverage ≥98%

### Reporting

After each phase:
1. Run coverage analysis
2. Update coverage report
3. Document remaining gaps
4. Adjust plan if needed

---

## Timeline Estimate

| Phase | Duration | Tests | Coverage Gain |
|-------|----------|-------|---------------|
| Phase 1 | 2-3 days | 40 | +21% (50%) |
| Phase 2 | 2-3 days | 50 | +25% (75%) |
| Phase 3 | 2-3 days | 35 | +15% (90%) |
| Phase 4 | 1-2 days | 35 | +8% (98%) |
| **Total** | **7-11 days** | **160** | **+68%** |

---

## Success Metrics

### Primary Metric
- **Line Coverage ≥ 98%**

### Secondary Metrics
- Function Coverage ≥ 98%
- Branch Coverage ≥ 95%
- Test Count ≥ 200
- All tests passing
- Test execution time < 30 seconds (unit + integration)

### Quality Metrics
- No test flakiness
- Clear test documentation
- Maintainable test code
- Fast test feedback loop

---

## Conclusion

This plan provides a **systematic, phased approach** to achieving 98% code coverage for the eBay MCP Server. By following this plan:

1. **Foundation First:** Critical infrastructure and core paths
2. **Build Up:** Complete business logic coverage
3. **Harden:** Edge cases and integration scenarios
4. **Perfect:** Final polish to 98%

Each phase builds confidence in the codebase and reduces production risk. The plan is flexible and can be adjusted based on findings during implementation.

**Next Step:** Begin Phase 1 implementation.

---

**Plan Created:** 2025-11-14
**Target Completion:** 2025-11-25
**Owner:** Development Team
