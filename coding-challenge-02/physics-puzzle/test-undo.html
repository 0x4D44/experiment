<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Undo Functionality Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #ccc;
        }
        .test-result.pass {
            background: #f1f8f4;
            border-left-color: #4caf50;
            color: #2e7d32;
        }
        .test-result.fail {
            background: #fff5f5;
            border-left-color: #f44336;
            color: #c62828;
        }
    </style>
</head>
<body>
    <h1>Undo Functionality Test</h1>
    <div id="results"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script>
        // Mock DOM elements
        document.getElementById = function(id) {
            const mockElements = {
                'gameScreen': { classList: { contains: () => false } },
                'mainMenu': { classList: { add: () => {} } },
                'gameCanvas': { clientWidth: 800, clientHeight: 600 },
                'currentLevel': { textContent: '' },
                'moveCount': { textContent: '' },
                'timeCount': { textContent: '' },
                'levelInstructions': { textContent: '' },
                'objectPalette': { innerHTML: '' },
                'totalStars': { textContent: '' },
                'maxStars': { textContent: '' },
                'winOverlay': { classList: { add: () => {}, remove: () => {} } }
            };
            return mockElements[id] || { classList: { add: () => {}, remove: () => {}, contains: () => false } };
        };

        document.querySelectorAll = function(selector) {
            if (selector === '.screen') {
                return [{ classList: { remove: () => {} } }];
            }
            if (selector === '.palette-item') {
                return [];
            }
            return [];
        };

        // Test undo functionality
        function testUndo() {
            const results = document.getElementById('results');
            let allPassed = true;

            // Test 1: History stores button reference
            try {
                const mockButton = {
                    dataset: { remaining: 2 },
                    innerHTML: 'Platform (2)',
                    disabled: false
                };

                const history = [];
                const mockBody = { id: 'test-body' };

                // Simulate placing object
                history.push({
                    type: 'place',
                    body: mockBody,
                    button: mockButton
                });

                if (history[0].button === mockButton) {
                    results.innerHTML += '<div class="test-result pass">✅ TEST 1 PASSED: History stores button reference</div>';
                } else {
                    results.innerHTML += '<div class="test-result fail">❌ TEST 1 FAILED: Button reference not stored</div>';
                    allPassed = false;
                }
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">❌ TEST 1 FAILED: ' + error.message + '</div>';
                allPassed = false;
            }

            // Test 2: Undo restores count using stored button reference
            try {
                const mockButton = {
                    dataset: { remaining: '0' },
                    innerHTML: 'Platform (0)',
                    disabled: true
                };

                const history = [{
                    type: 'place',
                    body: { id: 'test' },
                    button: mockButton
                }];

                const lastAction = history.pop();
                if (lastAction.button) {
                    const btn = lastAction.button;
                    btn.dataset.remaining = parseInt(btn.dataset.remaining) + 1;
                    btn.innerHTML = btn.innerHTML.replace(/\d+/, btn.dataset.remaining);
                    btn.disabled = false;

                    if (btn.dataset.remaining === '1' && btn.disabled === false) {
                        results.innerHTML += '<div class="test-result pass">✅ TEST 2 PASSED: Undo restores count correctly</div>';
                    } else {
                        results.innerHTML += '<div class="test-result fail">❌ TEST 2 FAILED: Count not restored correctly</div>';
                        allPassed = false;
                    }
                } else {
                    results.innerHTML += '<div class="test-result fail">❌ TEST 2 FAILED: Button reference not available</div>';
                    allPassed = false;
                }
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">❌ TEST 2 FAILED: ' + error.message + '</div>';
                allPassed = false;
            }

            // Test 3: Undo works after using all objects
            try {
                const mockButton = {
                    dataset: { remaining: '0' },
                    innerHTML: 'Platform (0)',
                    disabled: true,
                    classList: { remove: () => {} }
                };

                const history = [
                    { type: 'place', body: { id: 'obj1' }, button: mockButton },
                    { type: 'place', body: { id: 'obj2' }, button: mockButton }
                ];

                // Simulate undo after all objects used
                const lastAction = history.pop();
                if (lastAction.button) {
                    const btn = lastAction.button;
                    btn.dataset.remaining = parseInt(btn.dataset.remaining) + 1;
                    btn.disabled = false;

                    if (btn.dataset.remaining === '1' && btn.disabled === false) {
                        results.innerHTML += '<div class="test-result pass">✅ TEST 3 PASSED: Undo works after using all objects</div>';
                    } else {
                        results.innerHTML += '<div class="test-result fail">❌ TEST 3 FAILED: Undo doesn\'t restore properly</div>';
                        allPassed = false;
                    }
                } else {
                    results.innerHTML += '<div class="test-result fail">❌ TEST 3 FAILED: No button reference stored</div>';
                    allPassed = false;
                }
            } catch (error) {
                results.innerHTML += '<div class="test-result fail">❌ TEST 3 FAILED: ' + error.message + '</div>';
                allPassed = false;
            }

            // Summary
            if (allPassed) {
                results.innerHTML += '<div class="test-result pass"><h3>✅ ALL UNDO TESTS PASSED</h3></div>';
            } else {
                results.innerHTML += '<div class="test-result fail"><h3>❌ SOME TESTS FAILED</h3></div>';
            }
        }

        window.addEventListener('DOMContentLoaded', testUndo);
    </script>
</body>
</html>
