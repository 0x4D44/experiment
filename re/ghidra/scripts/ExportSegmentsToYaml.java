// Ghidra script: ExportSegmentsToYaml
// Emits memory block layout as YAML for Binary Ninja loader consumption.

import ghidra.app.script.GhidraScript;
import ghidra.program.model.mem.Memory;
import ghidra.program.model.mem.MemoryBlock;
import ghidra.program.model.address.Address;
import ghidra.program.model.lang.Language;

import java.io.BufferedWriter;
import java.io.File;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.security.MessageDigest;

public class ExportSegmentsToYaml extends GhidraScript {
    private static final String ENV_REPO_ROOT = "F1GP_REPO_ROOT";

    @Override
    public void run() throws Exception {
        if (currentProgram == null) {
            printerr("No active program");
            return;
        }
        String repoRoot = valueOrEnv("f1gp.repo.root", ENV_REPO_ROOT);
        if (repoRoot == null) {
            repoRoot = System.getProperty("user.dir");
        }
        File outFile = new File(repoRoot, "re/artifacts/segments.yml");
        outFile.getParentFile().mkdirs();

        Memory memory = currentProgram.getMemory();
        StringBuilder yaml = new StringBuilder();
        yaml.append("# Auto-generated by ExportSegmentsToYaml\n");
        yaml.append("binary_hash: sha256:").append(binaryHash()).append("\n");
        yaml.append("generated_at: \"").append(timestamp()).append("\"\n");
        yaml.append("language: \"").append(currentProgram.getLanguage().getLanguageID().getIdAsString()).append("\"\n");
        yaml.append("segments:\n");

        for (MemoryBlock block : memory.getBlocks()) {
            yaml.append("  - name: \"").append(block.getName()).append("\"\n");
            yaml.append("    start: 0x").append(Long.toHexString(block.getStart().getOffset())).append("\n");
            yaml.append("    size: ").append(block.getSize()).append("\n");
            yaml.append("    permissions: \"").append(perms(block)).append("\"\n");
            yaml.append("    comment: \"").append(block.getComment() == null ? "" : escape(block.getComment())).append("\"\n");
        }

        try (BufferedWriter writer = Files.newBufferedWriter(outFile.toPath(), StandardCharsets.UTF_8)) {
            writer.write(yaml.toString());
        }

        println("Exported segments to " + outFile.getAbsolutePath());
    }

    private String perms(MemoryBlock block) {
        StringBuilder sb = new StringBuilder();
        if (block.isRead()) sb.append('R');
        if (block.isWrite()) sb.append('W');
        if (block.isExecute()) sb.append('X');
        return sb.toString();
    }

    private String timestamp() {
        return new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'").format(new Date());
    }

    private String escape(String input) {
        return input.replace("\"", "\\\"");
    }

    private String binaryHash() throws Exception {
        MessageDigest digest = MessageDigest.getInstance("SHA-256");
        for (MemoryBlock block : currentProgram.getMemory().getBlocks()) {
            if (!block.isInitialized()) {
                continue;
            }
            byte[] data = new byte[(int) block.getSize()];
            block.getBytes(block.getStart(), data);
            digest.update(data);
        }
        byte[] hash = digest.digest();
        StringBuilder sb = new StringBuilder();
        for (byte b : hash) {
            sb.append(String.format("%02x", b));
        }
        return sb.toString();
    }

    private String valueOrEnv(String propertyKey, String envKey) {
        String value = System.getProperty(propertyKey);
        if (value != null && !value.isEmpty()) {
            return value;
        }
        value = System.getenv(envKey);
        if (value != null && !value.isEmpty()) {
            return value;
        }
        return null;
    }
}
