# Emits key data type declarations into re/artifacts/types/f1gp_types.h

import os
try:
    from ghidra.app.plugin.core.datamgr.util import DataTypeWriter, DataTypeWriterOptions
    from ghidra.program.model.data import Structure, Typedef, Array, Composite
except ImportError:
    print("Data type writer utilities not available; skipping type export")
    exit()

REPO_ROOT = os.environ.get('F1GP_REPO_ROOT', os.getcwd())
OUT_DIR = os.path.join(REPO_ROOT, 're', 'artifacts', 'types')
OUT_FILE = os.path.join(OUT_DIR, 'f1gp_types.h')
os.makedirs(OUT_DIR, exist_ok=True)

dtm = currentProgram.getDataTypeManager()
options = DataTypeWriterOptions()
options.setEmitHeader(False)
options.setEmitOffsets(True)
options.setPrependStructureComments(True)
writer = DataTypeWriter(dtm, options)

def should_export(dt):
    if dt is None:
        return False
    if dt.isNotYetDefined():
        return False
    cat = dt.getCategoryPath().getPath()
    if cat.startswith('/F1GP'):
        return True
    if isinstance(dt, Structure) or isinstance(dt, Composite):
        return True
    return False

with open(OUT_FILE, 'w', encoding='utf-8') as fh:
    fh.write('/* Auto-generated by EmitTypeDecls.py */\n\n')
    for dt in dtm.getAllDataTypes():
        if not should_export(dt):
            continue
        fh.write('// DataType: %s\n' % dt.getPathName())
        writer.write(dt, fh)
        fh.write('\n')

print('Wrote type declarations to %s' % OUT_FILE)
